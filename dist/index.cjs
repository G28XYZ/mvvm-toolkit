"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});require("reflect-metadata");const d=require("./tslib.es6-DqNExo46.cjs"),E=require("lodash"),_=require("mobx"),J=require("immer"),fe=require("mobx-react"),Zt=require("react"),R=(e,s,r)=>Reflect.getOwnMetadata(e,s)||r||{},F=(e,s,r)=>Reflect.defineMetadata(e,s,r);function _e(...e){try{return JSON.stringify(e),!0}catch{return!1}}function ae(e){if(e&&typeof e=="string"){let[s]=e.split(`
`)[2].replace(/at (get)?/,"").match(/.*/g)||[];return s&&(s=s.trim()),s}}const te={},lt=[];let ee=!1;const ye=(e,...s)=>{const r=new Error().stack;if(!ee)console.log("%c TODO","background: #222; color: #bada55",te),ee=!0;else{const i=ae(r);lt.includes(i)===!1&&(lt.push(i),Reflect.set(te,`${lt.length}) ${e}`,{msg:s,get path(){return console.info(s,i),i}}))}function o(...i){}return o},G=(e,s)=>!!e&&(typeof s=="string"||typeof s=="symbol"),K=e=>!!e&&typeof e=="object"&&"kind"in e,me=e=>({kind:"class",name:e,addInitializer:()=>{},metadata:{}}),X=Symbol("service-key"),ut=new Proxy({},Reflect);function re(e){const s=(o,i)=>{Object.defineProperty(o,i,{configurable:!0,enumerable:!0,get(){if(Object.prototype.hasOwnProperty.call(this,i))return Reflect.get(this,i);const n=N(e,"instance");if(n)return Object.defineProperty(this,i,{value:n,writable:!0,configurable:!0,enumerable:!0}),n},set(n){const a=N(e,"instance");Object.defineProperty(this,i,{value:a??n,writable:!0,configurable:!0,enumerable:!0})}})};function r(o,i){if(G(o,i)){s(o,i);return}return i.addInitializer(function(){return d.__awaiter(this,void 0,void 0,function*(){const n=N(e,"instance");n&&Object.hasOwn(this,i.name)&&Reflect.set(this,i.name,n)})}),n=>n}return r}function N(e,s){var r;const o=R(X,ut);if(typeof e!="string"){const i=R(X,e);if(i)return s&&s in i?i[s]:i;for(const n in o){const a=o[n];if(a.target===e){e=a.context.name;break}}}if(typeof e=="string")return s?(r=o[e])===null||r===void 0?void 0:r[s]:o[e]}function gt(e,s){const r=(i,n)=>{const a=String(typeof e=="string"&&e||typeof e=="object"&&e?.id||n?.name||i?.name),l=R(X,ut),h=new Proxy({target:i,instance:typeof e=="object"&&Reflect.get(e,"transient")||typeof e=="object"&&Reflect.get(e,"lazy")?i:new i,context:n,options:e},{get(m,b,g){var D,M;if(b==="instance"&&(!((D=m?.options)===null||D===void 0)&&D.transient))return new i;if(b==="instance"&&(!((M=m?.options)===null||M===void 0)&&M.lazy)&&m.instance===i){const T=new i;return Reflect.set(m,b,T,g),T}return Reflect.get(m,b,g)},set(m,b,g,D){return Reflect.set(m,b,g,D)}});l[a]=h,F(X,l,ut),F(X,l[a],i)};function o(i,n){var a,l;const h=i.__mvvm_legacy_source__,m=K(n)?n:me((l=(a=h?.name)!==null&&a!==void 0?a:i?.name)!==null&&l!==void 0?l:"");r(i,m),h&&h!==i&&F(X,R(X,i),h)}return E.isFunction(e)?o(e,s):e?(i,n)=>o(i,n):o}const ve=(e,s)=>{const{kind:r="class",name:o="",addInitializer:i=()=>{},metadata:n}=s?.ctx||{};return gt(s)(e,{kind:r,name:o,addInitializer:i,metadata:n}),N(e).instance},ge=Symbol("field-key"),be=Symbol("validation-key"),pe=Symbol("submit-key"),De=Symbol("exclude-key"),Ie=Symbol("prop-from-view-key");class Q{constructor(s={}){this.metadataKey=null,this.name=s?.name,this.callback=s?.callback}isInstance(s={}){return s instanceof Q||Object.getOwnPropertyNames(this).some(r=>Object.keys(s).includes(r))}fieldInstance(s,r){return this.fields(r).find(o=>o.name===s)}fields(s){const r=[],o=new Set;let i=s;for(;i;){const n=Reflect.getOwnMetadata(this.metadataKey,i);if(Array.isArray(n))for(const a of n){const l=a?.name;if(l!==void 0){const h=typeof l=="symbol"?l:String(l);if(o.has(h))continue;o.add(h)}r.push(a)}i=Object.getPrototypeOf(i)}return r}}class ht extends Q{constructor(){super(...arguments),this.metadataKey=be}}class ft extends Q{constructor(){super(...arguments),this.metadataKey=pe}}class _t extends Q{constructor(){super(...arguments),this.metadataKey=De}}class yt extends Q{constructor(s={}){super(s),this.factory=null,this.mapping=null,this.collectChanges=!1,this.name=null,this.ctx=null,this.metadataKey=ge,this.factory=s.factory,this.mapping=s.mapping,this.name=s.name,this.ctx=s.ctx,this.collectChanges=!!s.collectChanges}}class mt extends Q{constructor(s={}){super(s),this.metadataKey=Ie;for(const r in this)s&&r in s&&(this[r]=Reflect.get(s,r))}}function ct(e){const s=Object.assign({enumerable:!1,writable:!0},e);return function(r,o){if(G(r,o)){Object.defineProperty(r,o,{configurable:!0,enumerable:s.enumerable,get(){},set(i){Object.defineProperty(this,o,Object.assign({value:i},s))}});return}if(K(o)){const i=o;return i.kind==="field"?function(n){return Object.defineProperty(this,i.name,Object.assign({value:n},s)),n}:(i.addInitializer(function(){const n=Object.getOwnPropertyDescriptor(this,i.name);n&&Object.defineProperty(this,i.name,Object.assign(Object.assign({},n),{enumerable:s.enumerable}))}),r)}}}function j(e,s){return G(e,s)||K(s)?ct()(e,s):ct(e)}const Oe=()=>{var e;const s=globalThis;return!!((e=s.__MVVM_DEVTOOLS_HISTORY__)!==null&&e!==void 0?e:s.__MVVM_DEVTOOLS_AUTO__)},Se=e=>Oe()?!e||typeof e!="object"?{collectChanges:!0}:"collectChanges"in e?e:Object.assign(Object.assign({},e),{collectChanges:!0}):e;function Me(e){const s=(i,n)=>{const a=new ht({callback:e,name:String(n)}),l=R(a.metadataKey,i,new Array);F(a.metadataKey,[...l,a],i)},r=i=>{i.addInitializer(function(){const n=new ht({callback:e,name:String(i.name)}),a=R(n.metadataKey,this,new Array);F(n.metadataKey,[...a,n],this)})};function o(i,n){if(G(i,n)){s(i,n);return}if(K(n))return r(n),n.kind==="field"?a=>a:n}return e?((i,n)=>o(i,n)):(i=>i)}function we(e){const s=(i,n)=>{const a=new ft({callback:e,name:String(n)}),l=R(a.metadataKey,i,new Array);F(a.metadataKey,[...l,a],i)},r=i=>{i.addInitializer(function(){const n=new ft({callback:e,name:String(i.name)}),a=R(n.metadataKey,this,new Array);F(n.metadataKey,[...a,n],this)})};function o(i,n){if(G(i,n)){s(i,n);return}if(K(n))return r(n),n.kind==="field"?a=>a:n}return e?((i,n)=>o(i,n)):(i=>i)}function ke(e){const s=(i,n)=>{const a=new _t({callback:e,name:String(n)}),l=R(a.metadataKey,i,new Array);F(a.metadataKey,[...l,a],i)},r=i=>{i.addInitializer(function(){const n=new _t({callback:e,name:String(i.name)}),a=R(n.metadataKey,this,new Array);F(n.metadataKey,[...a,n],this)})};function o(i,n){if(G(i,n)){s(i,n);return}if(K(n))return r(n),n.kind==="field"?void 0:n}if(e)return((i,n)=>o(i,n))}function Ae(e,s){const r=Se(G(e,s)?void 0:e),o=(a,l)=>{const h=new yt(Object.assign(Object.assign({},r),{name:String(l),ctx:null})),m=R(h.metadataKey,a,new Array);F(h.metadataKey,[...m,h],a),Object.getOwnPropertyDescriptor(a,l)||Object.defineProperty(a,l,{configurable:!0,enumerable:!0,get(){const g=this;if(Object.prototype.hasOwnProperty.call(g,l))return Reflect.get(g,l);const D=g.initField,M=g.initData;if(M&&l in M&&typeof D=="function")return D.call(g,String(l),{skipValidation:!0}),Reflect.get(g,l)},set(g){const D=this,M=D.initField,T=D.initData;if(T&&!(l in T)&&Reflect.set(T,l,g),typeof M=="function"){M.call(D,String(l),{skipValidation:!0});return}Object.defineProperty(this,l,{value:g,writable:!0,configurable:!0,enumerable:!0})}})},i=a=>{a.addInitializer(function(){const l=this;if(typeof l.initField=="function"){const h=new yt(Object.assign(Object.assign({},r),{name:String(a.name),ctx:a})),m=R(h.metadataKey,this,new Array);F(h.metadataKey,[...m,h],this),l.initField.call(this,String(a.name))}})};function n(a,l){if(G(a,l)){o(a,l);return}if(K(l))return i(l),l.kind==="field"?h=>h:l}return G(e,s)?n(e,s):r&&!K(s)?(a,l)=>n(a,l):K(s)?n(void 0,s):(a,l)=>n(a,l)}function Te(e){const s=(i,n)=>{const a=new mt({name:e,originName:String(n)});a.name=e,a.originName=String(n);const l=R(a.metadataKey,i,new Array);F(a.metadataKey,[...l,a],i)},r=i=>{i.addInitializer(function(){const n=new mt,a=n.fields(this);for(const l in this)a instanceof Array&&i.name===l&&(n.name=e,n.originName=l,n.value=this[l],a.push(n));F(n.metadataKey,a,this)})};function o(i,n){if(G(i,n)){s(i,n);return}if(K(n))return r(n),n.kind==="field"?a=>a:n}return e?((i,n)=>o(i,n)):(i=>i)}function ze(e,s){const r=n=>class extends n{constructor(...a){super(...a),_.makeObservable(this)}},o=(n,a)=>{if(typeof Reflect?.getOwnMetadataKeys=="function")for(const l of Reflect.getOwnMetadataKeys(n)){const h=Reflect.getOwnMetadata(l,n);Reflect.defineMetadata(l,h,a)}};function i(n,a){if(!K(a)){const l=n,h=r(l);return Object.defineProperty(h,"__mvvm_legacy_source__",{value:l,configurable:!0}),o(l,h),h}a.addInitializer(function(){_.makeObservable(this)})}return e&&!K(s)||e?i(e,s):i}const Ee=()=>{var e;return(e=globalThis.__REDUX_DEVTOOLS_EXTENSION__)!==null&&e!==void 0?e:null},xe=()=>{var e;return(e=globalThis.__MVVM_DEVTOOLS_APPLYING__)!==null&&e!==void 0?e:0},at=e=>{var s,r;const o=globalThis;o.__MVVM_DEVTOOLS_APPLYING__=((s=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&s!==void 0?s:0)+1;try{return e()}finally{o.__MVVM_DEVTOOLS_APPLYING__=Math.max(0,((r=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&r!==void 0?r:1)-1)}},Pe=()=>xe()>0,ie=e=>({data:e.service.dumpData,historyIndex:e.service.historyIndex}),oe=(e,s={})=>{const r=Ee();if(!r)return()=>{};const o=r.connect({name:s.name,instanceId:s.instanceId});let i=!1;try{o.init(ie(e))}catch{}const n=_.reaction(()=>ie(e),l=>{var h;if(!(i||Pe()))try{o.send({type:(h=s.actionType)!==null&&h!==void 0?h:"model:update"},l)}catch{}}),a=o.subscribe(l=>{var h;if(l.type!=="DISPATCH")return;const m=(h=l.payload)===null||h===void 0?void 0:h.type;if(m==="RESET"){i=!0,at(()=>{try{e.service.toInit()}finally{i=!1}});return}if(m==="COMMIT"){i=!0,at(()=>{try{e.service.commit()}finally{i=!1}});return}if(m==="ROLLBACK"){i=!0,at(()=>{try{e.service.toInit()}finally{i=!1}});return}if(m==="JUMP_TO_ACTION"||m==="JUMP_TO_STATE"){if(!l.state)return;try{const b=JSON.parse(l.state),g=b.historyIndex,D=e.service.history,M=Array.isArray(D)&&D.length>0,T=typeof g=="number"&&(g===-1&&M||g>=0&&M&&g<D.length);i=!0,at(()=>{var C;try{if(T){e.service.goToHistory(g);return}const H=(C=b.data)!==null&&C!==void 0?C:b;_.runInAction(()=>{e.service.loadData(H)})}finally{i=!1}})}catch{}}});return()=>{n(),typeof a=="function"&&a(),typeof o.unsubscribe=="function"&&o.unsubscribe(),typeof o.disconnect=="function"&&o.disconnect()}};J.enablePatches();const Fe=new ft,q=new yt,Ve=new ht,je=new _t;let Re=(()=>{var e,s,r,o,i,n,a,l,h,m;let b=[],g,D=[],M=[],T,C=[],H=[],Y,Z=[],B=[],k,u=[],S=[],A,P=[],z=[],V,L=[],U=[],$,tt=[],it=[],st,nt=[],bt=[],pt,Dt=[],It=[],Ot,St=[],Mt=[],wt,kt=[],At=[],Tt,zt=[],Et=[],xt,Pt=[],Ft=[],Vt,jt,Rt=[],Ct=[],Lt,Kt,Ht,Gt,Yt,Bt,qt,Nt,Ut,$t,Wt,Jt;return e=class{get initData(){return d.__classPrivateFieldGet(this,s,"f")}set initData(t){d.__classPrivateFieldSet(this,s,t,"f")}get committedData(){return d.__classPrivateFieldGet(this,r,"f")}set committedData(t){d.__classPrivateFieldSet(this,r,t,"f")}get modified_(){return d.__classPrivateFieldGet(this,o,"f")}set modified_(t){d.__classPrivateFieldSet(this,o,t,"f")}get changes(){return d.__classPrivateFieldGet(this,i,"f")}set changes(t){d.__classPrivateFieldSet(this,i,t,"f")}get inverseChanges(){return d.__classPrivateFieldGet(this,n,"f")}set inverseChanges(t){d.__classPrivateFieldSet(this,n,t,"f")}get history(){return d.__classPrivateFieldGet(this,a,"f")}set history(t){d.__classPrivateFieldSet(this,a,t,"f")}get historyIndex(){return d.__classPrivateFieldGet(this,l,"f")}set historyIndex(t){d.__classPrivateFieldSet(this,l,t,"f")}constructor(t={},c){this[h]=(d.__runInitializers(this,b),d.__runInitializers(this,D,!0)),s.set(this,(d.__runInitializers(this,M),d.__runInitializers(this,C,null))),r.set(this,(d.__runInitializers(this,H),d.__runInitializers(this,Z,{}))),o.set(this,(d.__runInitializers(this,B),d.__runInitializers(this,u,{}))),this.draft=(d.__runInitializers(this,S),d.__runInitializers(this,P,null)),i.set(this,(d.__runInitializers(this,z),d.__runInitializers(this,L,[]))),n.set(this,(d.__runInitializers(this,U),d.__runInitializers(this,tt,[]))),a.set(this,(d.__runInitializers(this,it),d.__runInitializers(this,nt,[]))),l.set(this,(d.__runInitializers(this,bt),d.__runInitializers(this,Dt,-1))),this.initializedFields=(d.__runInitializers(this,It),d.__runInitializers(this,St,void 0)),this.legacyInitDone=(d.__runInitializers(this,Mt),d.__runInitializers(this,kt,!1)),this.rawInitData=(d.__runInitializers(this,At),d.__runInitializers(this,zt,null)),this.options=(d.__runInitializers(this,Et),d.__runInitializers(this,Pt,void 0)),this.historyMuted=(d.__runInitializers(this,Ft),d.__runInitializers(this,Rt,!1)),this.serviceApi=(d.__runInitializers(this,Ct),{loadData:f=>this.loadData(f),reject:()=>this.reject(),commit:()=>this.commit(),commitField:f=>this.commitField(f),toInit:()=>this.toInit(),undo:()=>this.undo(),redo:()=>this.redo(),goToHistory:f=>this.goToHistory(f)}),this.options=c,this[J.immerable]=!0,this.init(t),this.autoAttachDevtools(),this.initLegacyFields()}resetToDefault(){this.modified_={},this.committedData={},this.changes=[],this.inverseChanges=[],this.history=[],this.historyIndex=-1}initValidation(t){if(t)Reflect.get(this.validation,t);else for(const c in this.validation)this.validation[c]}init(t={}){this.cloneForInit(t),this.resetToDefault(),this.createDraft(t),this.defineData(this.initData)}initField(t,c){const f=q.fieldInstance(t,this);if(f){t in this.initData||Reflect.set(this.initData,t,E.cloneDeep(Reflect.get(this,t)));const y=E.cloneDeep(this.initData),v=f?.factory?f.factory(y,this):Reflect.get(y,f.name);this.defineFieldValue(t,v),c?.skipValidation||this.initValidation(t),this.getInitializedFields().add(String(t))}}getInitializedFields(){return this.initializedFields||(this.initializedFields=new Set),this.initializedFields}initLegacyFields(){var t;if(this.legacyInitDone)return;const c=q.fields(this);if(!c.some(O=>Object.prototype.hasOwnProperty.call(this,O.name)))return;this.legacyInitDone=!0;const y=this.getInitializedFields(),v=(t=this.rawInitData)!==null&&t!==void 0?t:this.initData;if(v&&v!==this.initData)try{this.initData=E.cloneDeep(v)}catch{this.initData=Object.assign({},v)}for(const O of c){const p=String(O.name);if(v&&p in v){const x=q.fieldInstance(p,this);if(!x)continue;if(!y.has(p)){const W=E.cloneDeep(v),et=x.factory?x.factory(W,this):Reflect.get(W,x.name);this.defineFieldValue(p,et),Reflect.set(this,p,et),y.add(p)}continue}y.has(p)||this.initField(p,{skipValidation:!0})}}createDraft(t){const c={};for(const f in t)q.fieldInstance(f,this)&&Reflect.set(c,f,E.cloneDeep(t[f]));this.draft=J.createDraft(c)}autoAttachDevtools(){var t,c,f,y,v,O,p,w,x,W,et,rt;const ot=globalThis;if(!ot.__MVVM_DEVTOOLS_AUTO__||((c=(t=this.options)===null||t===void 0?void 0:t.devtools)===null||c===void 0?void 0:c.enabled)===!1)return;const Xt=(p=(v=(y=(f=this.options)===null||f===void 0?void 0:f.devtools)===null||y===void 0?void 0:y.name)!==null&&v!==void 0?v:(O=this.constructor)===null||O===void 0?void 0:O.name)!==null&&p!==void 0?p:"Model",Qt=((w=ot.__MVVM_DEVTOOLS_SEQ__)!==null&&w!==void 0?w:0)+1;ot.__MVVM_DEVTOOLS_SEQ__=Qt;const ue=(et=(W=(x=this.options)===null||x===void 0?void 0:x.devtools)===null||W===void 0?void 0:W.instanceId)!==null&&et!==void 0?et:`${Xt}#${Qt}`;((rt=globalThis.queueMicrotask)!==null&&rt!==void 0?rt:(he=>Promise.resolve().then(he)))(()=>oe(this,{name:Xt,instanceId:ue}))}withHistoryMuted(t){this.historyMuted=!0;try{t()}finally{this.historyMuted=!1}}syncChangesFromHistory(){const t=this.historyIndex>=0?this.history.slice(0,this.historyIndex+1):[];this.changes=t.flatMap(c=>c.patches),this.inverseChanges=t.flatMap(c=>c.inversePatches)}applyHistoryPatches(t){if(!t.length)return;J.applyPatches(this.draft,t);const c=new Set(t.map(f=>f.field).filter(Boolean));c.size!==0&&this.withHistoryMuted(()=>{for(const f of c){const y=this.draft,v=this.initData,O=Reflect.has(y,f),p=Reflect.get(O?y:v,f);let w=p;try{w=E.cloneDeep(p)}catch{w=p}Reflect.set(this,f,w),this.defineFieldValue(f,Reflect.get(this,f))}})}produceDraft(t,c,f){if(this.historyMuted)return;let y,v=[];t&&(y=t.split(".")[0],y&&!q.fieldInstance(y,this).collectChanges)||(J.produce(this.draft,O=>{if(t){let p=O;const w=t.split(".");if(w.length>1)for(let x=0;x<w.length&&!(!(x==w.length-1)&&!E.isObject(p));x++)E.isObject(p)&&(p=p[w[x]]);else f=t;p&&(p[f]=c)}},(O,p)=>{y&&(O=O.map(w=>Object.assign(Object.assign({},w),{field:y})),p=p.map(w=>Object.assign(Object.assign({},w),{field:y}))),v=O,!(!O.length&&!p.length)&&(this.historyIndex<this.history.length-1&&(this.history=this.history.slice(0,this.historyIndex+1),this.syncChangesFromHistory()),this.changes.push(...O),this.inverseChanges.push(...p),this.history.push({patches:O,inversePatches:p}),this.historyIndex=this.history.length-1)}),v.length&&J.applyPatches(this.draft,v))}createObservable(t,c,f,y=f){return t=_.isObservable(t)?t:_.observable.box(t),new Proxy(t.get(),{get:(v,O,p)=>{const w=Reflect.get(v,O,p);return w&&typeof w=="object"&&!(w instanceof e)&&!_.isObservable(t)?this.createObservable(w,String(O),c,`${y}.${String(O)}`):w},set:(v,O,p,w)=>{const x=Reflect.set(v,O,p,w);return t.set(p),this.produceDraft(y,t.get(),String(O)),this.checkChange(f,Reflect.get(this,f)),x}})}defineFieldValue(t,c){const f=q.fieldInstance(t,this);return c&&typeof c=="object"&&(c=this.createObservable(c,t,t)),c=_.observable.box(c),Reflect.defineProperty(this,f.name,{get(){return c.get()},set:y=>{_.runInAction(()=>c.set(y)),this.produceDraft(f.name,c.get()),this.checkChange(f.name,c.get())},enumerable:!0,configurable:!0}),c}cloneForInit(t){if(t)try{const c=E.cloneDeep(t);this.initData=c,this.rawInitData=c}catch{const f=Object.assign({},t);this.initData=f,this.rawInitData=f}else this.rawInitData=null}checkChange(t,c){const f=E.cloneDeep(c),y=E.cloneDeep(Reflect.get(this.committedData,t))||E.cloneDeep(Reflect.get(this.initData,t)),v=t&&t in this.initData&&!E.isEqual(y,f);return _.runInAction(()=>{v&&Reflect.set(this.modified_,t,E.cloneDeep(y)||y);for(const O in this.modified_)t===O&&t in this.modified_&&E.isEqual(y,f)&&delete this.modified_[O]}),v}defineData(t){for(const c in this){if(!Object.prototype.hasOwnProperty.call(this,c))continue;q.fieldInstance(c,this)&&(Reflect.set(this,c,Reflect.get(t,c)),this.initField(c))}}get dirty(){return!E.isEmpty(this.modified_)}commit(){for(const t of q.fields(this))this.commitField(t.name);this.modified_={}}commitField(t){for(const c in this)c in this.modified_&&Reflect.set(this.committedData,c,this[c]);delete this.modified_[t],this.modified_=Object.assign({},this.modified_)}reject(){for(const t in this)t in this.modified_&&(this[t]=Reflect.get(this.modified_,t),this.commitField(t),this.defineFieldValue(t,this[t]));this.commit()}toInit(){return this.withHistoryMuted(()=>{for(const t in this)if(t in this.initData){const c=Reflect.get(this.initData,t);this[t]=c,this.initField(t)}this.init(this.initData)}),this}undo(){if(this.historyIndex<0)return;const t=this.history[this.historyIndex];this.historyIndex-=1,this.applyHistoryPatches(t.inversePatches),this.syncChangesFromHistory()}redo(){if(this.historyIndex>=this.history.length-1)return;const t=this.historyIndex+1,c=this.history[t];this.historyIndex=t,this.applyHistoryPatches(c.patches),this.syncChangesFromHistory()}goToHistory(t){if(!(t<-1||t>=this.history.length)&&t!==this.historyIndex){for(;this.historyIndex<t;){const c=this.historyIndex+1,f=this.history[c];this.historyIndex=c,this.applyHistoryPatches(f.patches)}for(;this.historyIndex>t;){const c=this.history[this.historyIndex];this.historyIndex-=1,this.applyHistoryPatches(c.inversePatches)}this.syncChangesFromHistory()}}loadData(t){return this.withHistoryMuted(()=>{this.init(t),this.defineData(this.initData)}),this}get dumpData(){this.initLegacyFields();const t=Object.create({}),c=y=>{const v=Fe.fieldInstance(y,this);return v?.callback?v.callback(Reflect.get(this,y),this):Reflect.get(this,y)},f=y=>{const v=je.fieldInstance(y,this);if(v)switch(typeof v.callback){case"boolean":return!!v.callback;case"function":return v.callback(Reflect.get(this,y),this)}return!1};q.fields(this).forEach(y=>{var v;if(y.name in this)return!((v=this.options)===null||v===void 0)&&v.byFields&&!this.options.byFields.includes(y.name)||f(y.name)?void 0:Reflect.set(t,y.name,c(y.name))});try{return E.cloneDeep(t)}catch{return t&&Object.assign({},t)}}get validation(){this.initLegacyFields();const t={};for(const c in this){const f=Ve.fieldInstance(c,this);f&&Reflect.set(t,c,f.callback(this[c],this)||"")}return t}get validAndDirty(){return this.dirty&&Object.values(this.validation).filter(Boolean).length===0}get service(){return Object.assign({dirty:this.dirty,dumpData:this.dumpData,validation:this.validation,changes:this.changes,inverseChanges:this.inverseChanges,history:this.history,historyIndex:this.historyIndex},this.serviceApi)}},s=new WeakMap,r=new WeakMap,o=new WeakMap,i=new WeakMap,n=new WeakMap,a=new WeakMap,l=new WeakMap,g=[j],h=d.__propKey(J.immerable),(()=>{const I=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;T=[_.observable,j],Y=[_.observable,j],k=[_.observable,j],A=[j],V=[_.observable,j],$=[_.observable,j],st=[_.observable,j],pt=[_.observable,j],Ot=[j],wt=[j],Tt=[j],xt=[j],Vt=[_.action],jt=[j],Lt=[_.action],Kt=[_.computed],Ht=[_.action],Gt=[_.action],Yt=[_.action],Bt=[_.action],qt=[_.action],Nt=[_.action],Ut=[_.action],$t=[_.computed],Wt=[_.computed],Jt=[(m=_.computed).struct.bind(m)],d.__esDecorate(e,null,T,{kind:"accessor",name:"initData",static:!1,private:!1,access:{has:t=>"initData"in t,get:t=>t.initData,set:(t,c)=>{t.initData=c}},metadata:I},C,H),d.__esDecorate(e,null,Y,{kind:"accessor",name:"committedData",static:!1,private:!1,access:{has:t=>"committedData"in t,get:t=>t.committedData,set:(t,c)=>{t.committedData=c}},metadata:I},Z,B),d.__esDecorate(e,null,k,{kind:"accessor",name:"modified_",static:!1,private:!1,access:{has:t=>"modified_"in t,get:t=>t.modified_,set:(t,c)=>{t.modified_=c}},metadata:I},u,S),d.__esDecorate(e,null,V,{kind:"accessor",name:"changes",static:!1,private:!1,access:{has:t=>"changes"in t,get:t=>t.changes,set:(t,c)=>{t.changes=c}},metadata:I},L,U),d.__esDecorate(e,null,$,{kind:"accessor",name:"inverseChanges",static:!1,private:!1,access:{has:t=>"inverseChanges"in t,get:t=>t.inverseChanges,set:(t,c)=>{t.inverseChanges=c}},metadata:I},tt,it),d.__esDecorate(e,null,st,{kind:"accessor",name:"history",static:!1,private:!1,access:{has:t=>"history"in t,get:t=>t.history,set:(t,c)=>{t.history=c}},metadata:I},nt,bt),d.__esDecorate(e,null,pt,{kind:"accessor",name:"historyIndex",static:!1,private:!1,access:{has:t=>"historyIndex"in t,get:t=>t.historyIndex,set:(t,c)=>{t.historyIndex=c}},metadata:I},Dt,It),d.__esDecorate(e,null,Vt,{kind:"method",name:"resetToDefault",static:!1,private:!1,access:{has:t=>"resetToDefault"in t,get:t=>t.resetToDefault},metadata:I},null,b),d.__esDecorate(e,null,Lt,{kind:"method",name:"produceDraft",static:!1,private:!1,access:{has:t=>"produceDraft"in t,get:t=>t.produceDraft},metadata:I},null,b),d.__esDecorate(e,null,Kt,{kind:"getter",name:"dirty",static:!1,private:!1,access:{has:t=>"dirty"in t,get:t=>t.dirty},metadata:I},null,b),d.__esDecorate(e,null,Ht,{kind:"method",name:"commit",static:!1,private:!1,access:{has:t=>"commit"in t,get:t=>t.commit},metadata:I},null,b),d.__esDecorate(e,null,Gt,{kind:"method",name:"commitField",static:!1,private:!1,access:{has:t=>"commitField"in t,get:t=>t.commitField},metadata:I},null,b),d.__esDecorate(e,null,Yt,{kind:"method",name:"reject",static:!1,private:!1,access:{has:t=>"reject"in t,get:t=>t.reject},metadata:I},null,b),d.__esDecorate(e,null,Bt,{kind:"method",name:"toInit",static:!1,private:!1,access:{has:t=>"toInit"in t,get:t=>t.toInit},metadata:I},null,b),d.__esDecorate(e,null,qt,{kind:"method",name:"undo",static:!1,private:!1,access:{has:t=>"undo"in t,get:t=>t.undo},metadata:I},null,b),d.__esDecorate(e,null,Nt,{kind:"method",name:"redo",static:!1,private:!1,access:{has:t=>"redo"in t,get:t=>t.redo},metadata:I},null,b),d.__esDecorate(e,null,Ut,{kind:"method",name:"goToHistory",static:!1,private:!1,access:{has:t=>"goToHistory"in t,get:t=>t.goToHistory},metadata:I},null,b),d.__esDecorate(e,null,$t,{kind:"getter",name:"validation",static:!1,private:!1,access:{has:t=>"validation"in t,get:t=>t.validation},metadata:I},null,b),d.__esDecorate(e,null,Wt,{kind:"getter",name:"validAndDirty",static:!1,private:!1,access:{has:t=>"validAndDirty"in t,get:t=>t.validAndDirty},metadata:I},null,b),d.__esDecorate(e,null,Jt,{kind:"getter",name:"service",static:!1,private:!1,access:{has:t=>"service"in t,get:t=>t.service},metadata:I},null,b),d.__esDecorate(null,null,g,{kind:"field",name:h,static:!1,private:!1,access:{has:t=>h in t,get:t=>t[h],set:(t,c)=>{t[h]=c}},metadata:I},D,M),d.__esDecorate(null,null,A,{kind:"field",name:"draft",static:!1,private:!1,access:{has:t=>"draft"in t,get:t=>t.draft,set:(t,c)=>{t.draft=c}},metadata:I},P,z),d.__esDecorate(null,null,Ot,{kind:"field",name:"initializedFields",static:!1,private:!1,access:{has:t=>"initializedFields"in t,get:t=>t.initializedFields,set:(t,c)=>{t.initializedFields=c}},metadata:I},St,Mt),d.__esDecorate(null,null,wt,{kind:"field",name:"legacyInitDone",static:!1,private:!1,access:{has:t=>"legacyInitDone"in t,get:t=>t.legacyInitDone,set:(t,c)=>{t.legacyInitDone=c}},metadata:I},kt,At),d.__esDecorate(null,null,Tt,{kind:"field",name:"rawInitData",static:!1,private:!1,access:{has:t=>"rawInitData"in t,get:t=>t.rawInitData,set:(t,c)=>{t.rawInitData=c}},metadata:I},zt,Et),d.__esDecorate(null,null,xt,{kind:"field",name:"options",static:!1,private:!1,access:{has:t=>"options"in t,get:t=>t.options,set:(t,c)=>{t.options=c}},metadata:I},Pt,Ft),d.__esDecorate(null,null,jt,{kind:"field",name:"historyMuted",static:!1,private:!1,access:{has:t=>"historyMuted"in t,get:t=>t.historyMuted,set:(t,c)=>{t.historyMuted=c}},metadata:I},Rt,Ct),I&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:I})})(),e})();const le=Symbol("store-key"),Ce=()=>{var e;return(e=globalThis.__REDUX_DEVTOOLS_EXTENSION__)!==null&&e!==void 0?e:null},Le=()=>{var e;return(e=globalThis.__MVVM_DEVTOOLS_APPLYING__)!==null&&e!==void 0?e:0},Ke=e=>{var s,r;const o=globalThis;o.__MVVM_DEVTOOLS_APPLYING__=((s=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&s!==void 0?s:0)+1;try{return e()}finally{o.__MVVM_DEVTOOLS_APPLYING__=Math.max(0,((r=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&r!==void 0?r:1)-1)}},He=()=>Le()>0,vt=e=>({items:e.items.map(s=>{var r,o;return{name:(o=(r=s.constructor)===null||r===void 0?void 0:r.name)!==null&&o!==void 0?o:"Model",data:s.service.dumpData,historyIndex:s.service.historyIndex}})}),Ge=e=>!!(e&&typeof e=="object"&&Array.isArray(e.items)),Ye=e=>{if(!e)return null;try{const s=JSON.parse(e);return Ge(s)?s:null}catch{return null}},ce=(e,s={})=>{var r,o;const i=Ce();if(!i)return()=>{};const n=i.connect({name:s.name,instanceId:s.instanceId});let a=!1,l=(o=(r=e.items[0])===null||r===void 0?void 0:r.constructor)!==null&&o!==void 0?o:null;try{n.init(vt(e))}catch{}const h=_.reaction(()=>vt(e),g=>{var D;if(a||He())return;const M=(D=e.items[0])===null||D===void 0?void 0:D.constructor;M&&(l=M);try{n.send({type:"store:update"},g)}catch{}}),m=g=>(a=!0,Ke(()=>{try{return g()}finally{a=!1}})),b=n.subscribe(g=>{var D;if(g.type!=="DISPATCH")return;const M=(D=g.payload)===null||D===void 0?void 0:D.type;if(M==="RESET"||M==="ROLLBACK"){m(()=>e.reset());return}if(M==="JUMP_TO_ACTION"||M==="JUMP_TO_STATE"){const T=Ye(g.state);if(!T)return;m(()=>{var C,H,Y;if(T.items.length===e.items.length&&e.items.every(S=>{var A,P;return typeof((A=S?.service)===null||A===void 0?void 0:A.goToHistory)=="function"||typeof((P=S?.service)===null||P===void 0?void 0:P.loadData)=="function"})){_.runInAction(()=>{T.items.forEach((S,A)=>{var P;const z=(P=e.items[A])===null||P===void 0?void 0:P.service,V=S.historyIndex,L=z?.history;if(Array.isArray(L)&&L.length>0&&typeof V=="number"&&typeof z?.goToHistory=="function"&&(V===-1&&L.length>0||V<L.length)){z.goToHistory(V);return}typeof z?.loadData=="function"&&z.loadData(S.data)})});return}const B=(H=(C=e.items[0])===null||C===void 0?void 0:C.constructor)!==null&&H!==void 0?H:l,k=T.items.map(S=>S.data);if(B){e.applyLoaded(k,{model:B,cash:!1}),l=B;return}e.applyLoaded(k,{cash:!1});const u=(Y=e.items[0])===null||Y===void 0?void 0:Y.constructor;u&&(l=u)})}});return()=>{h(),typeof b=="function"&&b(),typeof n.unsubscribe=="function"&&n.unsubscribe(),typeof n.disconnect=="function"&&n.disconnect()}};let Be=(()=>{var e,s,r;let o=[],i,n=[],a=[],l,h=[],m=[],b,g,D,M,T,C,H,Y,Z,B;return e=class{get items(){return d.__classPrivateFieldGet(this,s,"f")}set items(u){d.__classPrivateFieldSet(this,s,u,"f")}get _cash(){return d.__classPrivateFieldGet(this,r,"f")}set _cash(u){d.__classPrivateFieldSet(this,r,u,"f")}constructor(){s.set(this,(d.__runInitializers(this,o),d.__runInitializers(this,n,[]))),r.set(this,(d.__runInitializers(this,a),d.__runInitializers(this,h,[]))),d.__runInitializers(this,m),_.makeObservable(this),this.autoAttachDevtools()}add(u){this.items=this.items.concat(u)}addMany(u){u?.length&&(this.items=this.items.concat(u))}remove(u){this.items=this.items.filter(S=>S!==u)}find(u){return this.items.find(u)}filter(u){return this.items.filter(u)}findBy(u,S){return this.items.find(A=>A?.[u]===S)}clear(){this.items=[]}get size(){return this.items.length}get snapshot(){return vt(this)}get cash(){return this._cash}reset(){this.clear()}applyLoaded(u,S={}){const{model:A,mode:P="replace",cash:z=!0}=S;if(z&&this.setCash(u),P==="append"){const V=A?u.map(L=>new A(L)):u;this.addMany(V);return}this.items=A?u.map(V=>new A(V)):u}setCash(u){this._cash=u??[]}autoAttachDevtools(){var u,S,A,P,z,V,L,U;const $=globalThis;if(!$.__MVVM_DEVTOOLS_AUTO__)return;const tt=R(le,this.constructor,{})||{};if(((u=tt.devtools)===null||u===void 0?void 0:u.enabled)===!1)return;const it=(z=(A=(S=tt.devtools)===null||S===void 0?void 0:S.name)!==null&&A!==void 0?A:(P=this.constructor)===null||P===void 0?void 0:P.name)!==null&&z!==void 0?z:"Store",st=((V=$.__MVVM_DEVTOOLS_STORE_SEQ__)!==null&&V!==void 0?V:0)+1;$.__MVVM_DEVTOOLS_STORE_SEQ__=st;const nt=(U=(L=tt.devtools)===null||L===void 0?void 0:L.instanceId)!==null&&U!==void 0?U:`${it}#${st}`;ce(this,{name:it,instanceId:nt})}},s=new WeakMap,r=new WeakMap,(()=>{const k=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;i=[_.observable],l=[_.observable],b=[_.action],g=[_.action],D=[_.action],M=[_.action],T=[_.computed],C=[_.computed],H=[_.computed],Y=[_.action],Z=[_.action],B=[_.action],d.__esDecorate(e,null,i,{kind:"accessor",name:"items",static:!1,private:!1,access:{has:u=>"items"in u,get:u=>u.items,set:(u,S)=>{u.items=S}},metadata:k},n,a),d.__esDecorate(e,null,l,{kind:"accessor",name:"_cash",static:!1,private:!1,access:{has:u=>"_cash"in u,get:u=>u._cash,set:(u,S)=>{u._cash=S}},metadata:k},h,m),d.__esDecorate(e,null,b,{kind:"method",name:"add",static:!1,private:!1,access:{has:u=>"add"in u,get:u=>u.add},metadata:k},null,o),d.__esDecorate(e,null,g,{kind:"method",name:"addMany",static:!1,private:!1,access:{has:u=>"addMany"in u,get:u=>u.addMany},metadata:k},null,o),d.__esDecorate(e,null,D,{kind:"method",name:"remove",static:!1,private:!1,access:{has:u=>"remove"in u,get:u=>u.remove},metadata:k},null,o),d.__esDecorate(e,null,M,{kind:"method",name:"clear",static:!1,private:!1,access:{has:u=>"clear"in u,get:u=>u.clear},metadata:k},null,o),d.__esDecorate(e,null,T,{kind:"getter",name:"size",static:!1,private:!1,access:{has:u=>"size"in u,get:u=>u.size},metadata:k},null,o),d.__esDecorate(e,null,C,{kind:"getter",name:"snapshot",static:!1,private:!1,access:{has:u=>"snapshot"in u,get:u=>u.snapshot},metadata:k},null,o),d.__esDecorate(e,null,H,{kind:"getter",name:"cash",static:!1,private:!1,access:{has:u=>"cash"in u,get:u=>u.cash},metadata:k},null,o),d.__esDecorate(e,null,Y,{kind:"method",name:"reset",static:!1,private:!1,access:{has:u=>"reset"in u,get:u=>u.reset},metadata:k},null,o),d.__esDecorate(e,null,Z,{kind:"method",name:"applyLoaded",static:!1,private:!1,access:{has:u=>"applyLoaded"in u,get:u=>u.applyLoaded},metadata:k},null,o),d.__esDecorate(e,null,B,{kind:"method",name:"setCash",static:!1,private:!1,access:{has:u=>"setCash"in u,get:u=>u.setCash},metadata:k},null,o),k&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:k})})(),e})();function qe(e){return N(e,"instance")}function Ne(e){return((s,r)=>re(e)(s,r))}function Ue(e,s){const r=(o,i)=>{var n;const a=typeof e=="string"?{id:e}:typeof e=="object"?e:{id:(n=i?.name)!==null&&n!==void 0?n:o?.name};F(le,a,o),gt(a)(o,i)};return typeof e=="function"?r(e,s):(o,i)=>r(o,i)}class $e{}const dt=new mt;function We(e,s){return fe.observer((r={})=>{const{resolved:o,instance:i}=Zt.useMemo(()=>{const a=N(e)||(typeof e!="string"?{instance:new e}:void 0),l=a?.instance;return{resolved:a,instance:l}},[e]);if(Zt.useEffect(()=>{if(i)return typeof i.onInit=="function"&&i.onInit(),()=>{typeof i.onDispose=="function"&&i.onDispose()}},[i]),o){const n=dt.fields(i),a=n.length>0?n:dt.fields(Object.getPrototypeOf(i));for(const l in r)if(a instanceof Array){const h=a.find(m=>m.name===l);h&&Reflect.set(i,h.originName,Reflect.get(r,l))}return F(dt.metadataKey,a,i),s(Object.assign({viewModel:i},r))}return s(Object.assign({},r))})}const se={load:"load",failure:"failure",ready:"ready"},Je={load:"load",failure:"failure",ready:"ready"},ne=()=>{};class Xe{constructor(s,r){var o,i,n,a,l,h;this.isExecuting=!1,this.error=null,this.controllers=new Set,this.runningCount=0,this.runningPromise=null,this.queueTail=Promise.resolve(),this.disposed=!1,this.fn=s,this.opt=Object.assign({concurrency:(o=r?.concurrency)!==null&&o!==void 0?o:"ignore",trackError:(i=r?.trackError)!==null&&i!==void 0?i:!0,swallowError:(n=r?.swallowError)!==null&&n!==void 0?n:!0,abortable:(a=r?.abortable)!==null&&a!==void 0?a:!1},r),this.states=Object.assign(Object.assign({},se),(l=r?.states)!==null&&l!==void 0?l:{}),this.stateKeys=Object.assign(Object.assign({},Je),(h=r?.stateKeys)!==null&&h!==void 0?h:{}),_.makeAutoObservable(this,{fn:!1,opt:!1,states:!1,stateKeys:!1,resolveState:!1,getScope:!1,controllers:!1,runningCount:!1,runningPromise:!1,queueTail:!1,disposed:!1},{autoBind:!0})}get canExecute(){return this.disposed||!(this.opt.canExecute?this.opt.canExecute(this.getScope()):!0)?!1:this.opt.concurrency==="ignore"?!this.isExecuting:!0}resolveState(s){var r,o;const i=(r=this.stateKeys[s])!==null&&r!==void 0?r:s;return(o=this.states[i])!==null&&o!==void 0?o:se[s]}getScope(){return{state:this.state,states:this.states,isExecuting:this.isExecuting,error:this.error}}get state(){return this.isExecuting?this.resolveState("load"):this.error?this.resolveState("failure"):this.resolveState("ready")}resetError(){this.error=null}cancel(){var s,r;(r=(s=this.opt).onCancel)===null||r===void 0||r.call(s);for(const o of this.controllers)o.abort()}dispose(){this.disposed=!0,this.cancel()}execute(...s){var r;if(this.disposed)return Promise.resolve(void 0);if(!this.canExecute)return(r=this.runningPromise)!==null&&r!==void 0?r:Promise.resolve(void 0);const o=n=>{this.runningPromise=n;const a=()=>{this.runningPromise===n&&(this.runningPromise=null)};return n.then(a,a),n},i=()=>d.__awaiter(this,void 0,void 0,function*(){var n,a;if(this.disposed)return;const l=this.opt.abortable?new AbortController:null;l&&this.controllers.add(l),_.runInAction(()=>{this.runningCount+=1,this.isExecuting=this.runningCount>0,this.opt.trackError&&(this.error=null)});let h=null;try{const m=this.opt.abortable?l.signal:void 0;return h=this.fn(...s,m),yield h}catch(m){if(this.opt.abortable&&l?.signal.aborted)return;if(this.opt.trackError&&_.runInAction(()=>{this.error=m}),(a=(n=this.opt).onError)===null||a===void 0||a.call(n,m),!this.opt.swallowError)throw m;return}finally{_.runInAction(()=>{this.runningCount=Math.max(0,this.runningCount-1),this.isExecuting=this.runningCount>0}),l&&this.controllers.delete(l)}});switch(this.opt.concurrency){case"parallel":return o(i());case"restart":return this.cancel(),o(i());case"queue":{const n=this.queueTail.then(i,i);return this.queueTail=n.then(ne,ne),o(n)}default:return this.isExecuting&&this.runningPromise?this.runningPromise:o(i())}}}function de(e,s){return new Xe(e,s)}function Qe(e,s){const r=_.flow(e),o=new Set,i=s?.onCancel;return de((...a)=>{const l=r(...a);o.add(l);const h=()=>{o.delete(l)};return l.then(h,h),new Promise((m,b)=>{l.then(m,g=>{if(_.isFlowCancellationError(g)){m(void 0);return}b(g)})})},Object.assign(Object.assign({},s),{onCancel:()=>{var a;for(const l of o)(a=l.cancel)===null||a===void 0||a.call(l);i?.()}}))}function Ze(e){return function(...s){return _.runInAction(()=>e.apply(this,s))}}exports.GetService=N;exports.GetStore=qe;exports.Inject=re;exports.InjectStore=Ne;exports.MakeObservable=ze;exports.Model=Re;exports.PropFromView=Te;exports.Service=gt;exports.SetService=ve;exports.Store=Ue;exports.StoreBase=Be;exports.TODO=ye;exports.ViewModel=$e;exports.asyncCommand=de;exports.attachModelDevtools=oe;exports.attachStoreDevtools=ce;exports.commandAction=Ze;exports.defineMetadata=F;exports.define_prop=j;exports.exclude=ke;exports.field=Ae;exports.flowCommand=Qe;exports.getExecutingFunctionNameByStack=ae;exports.getOwnMetadata=R;exports.isSerializable=_e;exports.submit=we;exports.validation=Me;exports.view=We;
//# sourceMappingURL=index.cjs.map
