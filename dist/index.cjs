"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});require("reflect-metadata");const l=require("./tslib.es6-DqNExo46.cjs"),V=require("lodash"),y=require("mobx"),J=require("immer"),de=require("mobx-react"),Zt=require("react"),R=(e,a,u)=>Reflect.getOwnMetadata(e,a)||u||{},P=(e,a,u)=>Reflect.defineMetadata(e,a,u);function ue(...e){try{return JSON.stringify(e),!0}catch{return!1}}function se(e){if(e&&typeof e=="string"){let[a]=e.split(`
`)[2].replace(/at (get)?/,"").match(/.*/g)||[];return a&&(a=a.trim()),a}}const te={},lt=[];let ee=!1;const he=(e,...a)=>{const u=new Error().stack;if(!ee)console.log("%c TODO","background: #222; color: #bada55",te),ee=!0;else{const i=se(u);lt.includes(i)===!1&&(lt.push(i),Reflect.set(te,`${lt.length}) ${e}`,{msg:a,get path(){return console.info(a,i),i}}))}function o(...i){}return o},G=(e,a)=>!!e&&(typeof a=="string"||typeof a=="symbol"),H=e=>!!e&&typeof e=="object"&&"kind"in e,_e=e=>({kind:"class",name:e,addInitializer:()=>{},metadata:{}}),X=Symbol("service-key"),ut=new Proxy({},Reflect);function ae(e){const a=(o,i)=>{Object.defineProperty(o,i,{configurable:!0,enumerable:!0,get(){if(Object.prototype.hasOwnProperty.call(this,i))return Reflect.get(this,i);const s=U(e,"instance");if(s)return Object.defineProperty(this,i,{value:s,writable:!0,configurable:!0,enumerable:!0}),s},set(s){const n=U(e,"instance");Object.defineProperty(this,i,{value:n??s,writable:!0,configurable:!0,enumerable:!0})}})};function u(o,i){if(G(o,i)){a(o,i);return}return i.addInitializer(function(){return l.__awaiter(this,void 0,void 0,function*(){const s=U(e,"instance");s&&Object.hasOwn(this,i.name)&&Reflect.set(this,i.name,s)})}),s=>s}return u}function U(e,a){var u;const o=R(X,ut);if(typeof e!="string"){const i=R(X,e);if(i)return a&&a in i?i[a]:i;for(const s in o){const n=o[s];if(n.target===e){e=n.context.name;break}}}if(typeof e=="string")return a?(u=o[e])===null||u===void 0?void 0:u[a]:o[e]}function gt(e,a){const u=(i,s)=>{const n=String(typeof e=="string"&&e||typeof e=="object"&&e?.id||s?.name||i?.name),d=R(X,ut),_=new Proxy({target:i,instance:typeof e=="object"&&Reflect.get(e,"transient")||typeof e=="object"&&Reflect.get(e,"lazy")?i:new i,context:s,options:e},{get(v,p,g){var D,S;if(p==="instance"&&(!((D=v?.options)===null||D===void 0)&&D.transient))return new i;if(p==="instance"&&(!((S=v?.options)===null||S===void 0)&&S.lazy)&&v.instance===i){const A=new i;return Reflect.set(v,p,A,g),A}return Reflect.get(v,p,g)},set(v,p,g,D){return Reflect.set(v,p,g,D)}});d[n]=_,P(X,d,ut),P(X,d[n],i)};function o(i,s){var n,d;const _=i.__mvvm_legacy_source__,v=H(s)?s:_e((d=(n=_?.name)!==null&&n!==void 0?n:i?.name)!==null&&d!==void 0?d:"");u(i,v),_&&_!==i&&P(X,R(X,i),_)}return V.isFunction(e)?o(e,a):e?(i,s)=>o(i,s):o}const fe=(e,a)=>{const{kind:u="class",name:o="",addInitializer:i=()=>{},metadata:s}=a?.ctx||{};return gt(a)(e,{kind:u,name:o,addInitializer:i,metadata:s}),U(e).instance},ye=Symbol("field-key"),me=Symbol("validation-key"),ve=Symbol("submit-key"),ge=Symbol("exclude-key"),be=Symbol("prop-from-view-key");class Q{constructor(a={}){this.metadataKey=null,this.name=a?.name,this.callback=a?.callback}isInstance(a={}){return a instanceof Q||Object.getOwnPropertyNames(this).some(u=>Object.keys(a).includes(u))}fieldInstance(a,u){return this.fields(u).find(o=>o.name===a)}fields(a){const u=[],o=new Set;let i=a;for(;i;){const s=Reflect.getOwnMetadata(this.metadataKey,i);if(Array.isArray(s))for(const n of s){const d=n?.name;if(d!==void 0){const _=typeof d=="symbol"?d:String(d);if(o.has(_))continue;o.add(_)}u.push(n)}i=Object.getPrototypeOf(i)}return u}}class ht extends Q{constructor(){super(...arguments),this.metadataKey=me}}class _t extends Q{constructor(){super(...arguments),this.metadataKey=ve}}class ft extends Q{constructor(){super(...arguments),this.metadataKey=ge}}class yt extends Q{constructor(a={}){super(a),this.factory=null,this.mapping=null,this.collectChanges=!1,this.name=null,this.ctx=null,this.metadataKey=ye,this.factory=a.factory,this.mapping=a.mapping,this.name=a.name,this.ctx=a.ctx,this.collectChanges=!!a.collectChanges}}class mt extends Q{constructor(a={}){super(a),this.metadataKey=be;for(const u in this)a&&u in a&&(this[u]=Reflect.get(a,u))}}function ct(e){const a=Object.assign({enumerable:!1,writable:!0},e);return function(u,o){if(G(u,o)){Object.defineProperty(u,o,{configurable:!0,enumerable:a.enumerable,get(){},set(i){Object.defineProperty(this,o,Object.assign({value:i},a))}});return}if(H(o)){const i=o;return i.kind==="field"?function(s){return Object.defineProperty(this,i.name,Object.assign({value:s},a)),s}:(i.addInitializer(function(){const s=Object.getOwnPropertyDescriptor(this,i.name);s&&Object.defineProperty(this,i.name,Object.assign(Object.assign({},s),{enumerable:a.enumerable}))}),u)}}}function E(e,a){return G(e,a)||H(a)?ct()(e,a):ct(e)}const pe=()=>{var e;const a=globalThis;return!!((e=a.__MVVM_DEVTOOLS_HISTORY__)!==null&&e!==void 0?e:a.__MVVM_DEVTOOLS_AUTO__)},De=e=>pe()?!e||typeof e!="object"?{collectChanges:!0}:"collectChanges"in e?e:Object.assign(Object.assign({},e),{collectChanges:!0}):e;function Ie(e){const a=(i,s)=>{const n=new ht({callback:e,name:String(s)}),d=R(n.metadataKey,i,new Array);P(n.metadataKey,[...d,n],i)},u=i=>{i.addInitializer(function(){const s=new ht({callback:e,name:String(i.name)}),n=R(s.metadataKey,this,new Array);P(s.metadataKey,[...n,s],this)})};function o(i,s){if(G(i,s)){a(i,s);return}if(H(s))return u(s),s.kind==="field"?n=>n:s}return e?((i,s)=>o(i,s)):(i=>i)}function Oe(e){const a=(i,s)=>{const n=new _t({callback:e,name:String(s)}),d=R(n.metadataKey,i,new Array);P(n.metadataKey,[...d,n],i)},u=i=>{i.addInitializer(function(){const s=new _t({callback:e,name:String(i.name)}),n=R(s.metadataKey,this,new Array);P(s.metadataKey,[...n,s],this)})};function o(i,s){if(G(i,s)){a(i,s);return}if(H(s))return u(s),s.kind==="field"?n=>n:s}return e?((i,s)=>o(i,s)):(i=>i)}function Me(e){const a=(i,s)=>{const n=new ft({callback:e,name:String(s)}),d=R(n.metadataKey,i,new Array);P(n.metadataKey,[...d,n],i)},u=i=>{i.addInitializer(function(){const s=new ft({callback:e,name:String(i.name)}),n=R(s.metadataKey,this,new Array);P(s.metadataKey,[...n,s],this)})};function o(i,s){if(G(i,s)){a(i,s);return}if(H(s))return u(s),s.kind==="field"?void 0:s}if(e)return((i,s)=>o(i,s))}function Se(e,a){const u=De(G(e,a)?void 0:e),o=(n,d)=>{const _=new yt(Object.assign(Object.assign({},u),{name:String(d),ctx:null})),v=R(_.metadataKey,n,new Array);P(_.metadataKey,[...v,_],n),Object.getOwnPropertyDescriptor(n,d)||Object.defineProperty(n,d,{configurable:!0,enumerable:!0,get(){const g=this;if(Object.prototype.hasOwnProperty.call(g,d))return Reflect.get(g,d);const D=g.initField,S=g.initData;if(S&&d in S&&typeof D=="function")return D.call(g,String(d),{skipValidation:!0}),Reflect.get(g,d)},set(g){const D=this,S=D.initField,A=D.initData;if(A&&!(d in A)&&Reflect.set(A,d,g),typeof S=="function"){S.call(D,String(d),{skipValidation:!0});return}Object.defineProperty(this,d,{value:g,writable:!0,configurable:!0,enumerable:!0})}})},i=n=>{n.addInitializer(function(){const d=this;if(typeof d.initField=="function"){const _=new yt(Object.assign(Object.assign({},u),{name:String(n.name),ctx:n})),v=R(_.metadataKey,this,new Array);P(_.metadataKey,[...v,_],this),d.initField.call(this,String(n.name))}})};function s(n,d){if(G(n,d)){o(n,d);return}if(H(d))return i(d),d.kind==="field"?_=>_:d}return G(e,a)?s(e,a):u&&!H(a)?(n,d)=>s(n,d):H(a)?s(void 0,a):(n,d)=>s(n,d)}function ke(e){const a=(i,s)=>{const n=new mt({name:e,originName:String(s)});n.name=e,n.originName=String(s);const d=R(n.metadataKey,i,new Array);P(n.metadataKey,[...d,n],i)},u=i=>{i.addInitializer(function(){const s=new mt,n=s.fields(this);for(const d in this)n instanceof Array&&i.name===d&&(s.name=e,s.originName=d,s.value=this[d],n.push(s));P(s.metadataKey,n,this)})};function o(i,s){if(G(i,s)){a(i,s);return}if(H(s))return u(s),s.kind==="field"?n=>n:s}return e?((i,s)=>o(i,s)):(i=>i)}function we(e,a){const u=s=>class extends s{constructor(...n){super(...n),y.makeObservable(this)}},o=(s,n)=>{if(typeof Reflect?.getOwnMetadataKeys=="function")for(const d of Reflect.getOwnMetadataKeys(s)){const _=Reflect.getOwnMetadata(d,s);Reflect.defineMetadata(d,_,n)}};function i(s,n){if(!H(n)){const d=s,_=u(d);return Object.defineProperty(_,"__mvvm_legacy_source__",{value:d,configurable:!0}),o(d,_),_}n.addInitializer(function(){y.makeObservable(this)})}return e&&!H(a)||e?i(e,a):i}const ze=()=>{var e;return(e=globalThis.__REDUX_DEVTOOLS_EXTENSION__)!==null&&e!==void 0?e:null},Ae=()=>{var e;return(e=globalThis.__MVVM_DEVTOOLS_APPLYING__)!==null&&e!==void 0?e:0},nt=e=>{var a,u;const o=globalThis;o.__MVVM_DEVTOOLS_APPLYING__=((a=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&a!==void 0?a:0)+1;try{return e()}finally{o.__MVVM_DEVTOOLS_APPLYING__=Math.max(0,((u=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&u!==void 0?u:1)-1)}},Te=()=>Ae()>0,ie=e=>({data:e.service.dumpData,historyIndex:e.service.historyIndex}),ne=(e,a={})=>{const u=ze();if(!u)return()=>{};const o=u.connect({name:a.name,instanceId:a.instanceId});let i=!1;try{o.init(ie(e))}catch{}const s=y.reaction(()=>ie(e),d=>{var _;if(!(i||Te()))try{o.send({type:(_=a.actionType)!==null&&_!==void 0?_:"model:update"},d)}catch{}}),n=o.subscribe(d=>{var _;if(d.type!=="DISPATCH")return;const v=(_=d.payload)===null||_===void 0?void 0:_.type;if(v==="RESET"){i=!0,nt(()=>{try{e.service.toInit()}finally{i=!1}});return}if(v==="COMMIT"){i=!0,nt(()=>{try{e.service.commit()}finally{i=!1}});return}if(v==="ROLLBACK"){i=!0,nt(()=>{try{e.service.toInit()}finally{i=!1}});return}if(v==="JUMP_TO_ACTION"||v==="JUMP_TO_STATE"){if(!d.state)return;try{const p=JSON.parse(d.state),g=p.historyIndex,D=e.service.history,S=Array.isArray(D)&&D.length>0,A=typeof g=="number"&&(g===-1&&S||g>=0&&S&&g<D.length);i=!0,nt(()=>{var L;try{if(A){e.service.goToHistory(g);return}const K=(L=p.data)!==null&&L!==void 0?L:p;y.runInAction(()=>{e.service.loadData(K)})}finally{i=!1}})}catch{}}});return()=>{s(),typeof n=="function"&&n(),typeof o.unsubscribe=="function"&&o.unsubscribe(),typeof o.disconnect=="function"&&o.disconnect()}};J.enablePatches();const Ve=new _t,N=new yt,Fe=new ht,xe=new ft;let Pe=(()=>{var e,a,u,o,i,s,n,d,_,v;let p=[],g,D=[],S=[],A,L=[],K=[],Y,Z=[],B=[],w,c=[],M=[],z,x=[],T=[],j,C=[],q=[],$,tt=[],it=[],st,at=[],bt=[],pt,Dt=[],It=[],Ot,Mt=[],St=[],kt,wt=[],zt=[],At,Tt=[],Vt=[],Ft,xt=[],Pt=[],jt,Et,Rt=[],Lt=[],Ct,Ht,Kt,Gt,Yt,Bt,Nt,Ut,qt,$t,Wt,Jt;return e=class{get initData(){return l.__classPrivateFieldGet(this,a,"f")}set initData(t){l.__classPrivateFieldSet(this,a,t,"f")}get committedData(){return l.__classPrivateFieldGet(this,u,"f")}set committedData(t){l.__classPrivateFieldSet(this,u,t,"f")}get modified_(){return l.__classPrivateFieldGet(this,o,"f")}set modified_(t){l.__classPrivateFieldSet(this,o,t,"f")}get changes(){return l.__classPrivateFieldGet(this,i,"f")}set changes(t){l.__classPrivateFieldSet(this,i,t,"f")}get inverseChanges(){return l.__classPrivateFieldGet(this,s,"f")}set inverseChanges(t){l.__classPrivateFieldSet(this,s,t,"f")}get history(){return l.__classPrivateFieldGet(this,n,"f")}set history(t){l.__classPrivateFieldSet(this,n,t,"f")}get historyIndex(){return l.__classPrivateFieldGet(this,d,"f")}set historyIndex(t){l.__classPrivateFieldSet(this,d,t,"f")}constructor(t={},r){this[_]=(l.__runInitializers(this,p),l.__runInitializers(this,D,!0)),a.set(this,(l.__runInitializers(this,S),l.__runInitializers(this,L,null))),u.set(this,(l.__runInitializers(this,K),l.__runInitializers(this,Z,{}))),o.set(this,(l.__runInitializers(this,B),l.__runInitializers(this,c,{}))),this.draft=(l.__runInitializers(this,M),l.__runInitializers(this,x,null)),i.set(this,(l.__runInitializers(this,T),l.__runInitializers(this,C,[]))),s.set(this,(l.__runInitializers(this,q),l.__runInitializers(this,tt,[]))),n.set(this,(l.__runInitializers(this,it),l.__runInitializers(this,at,[]))),d.set(this,(l.__runInitializers(this,bt),l.__runInitializers(this,Dt,-1))),this.initializedFields=(l.__runInitializers(this,It),l.__runInitializers(this,Mt,void 0)),this.legacyInitDone=(l.__runInitializers(this,St),l.__runInitializers(this,wt,!1)),this.rawInitData=(l.__runInitializers(this,zt),l.__runInitializers(this,Tt,null)),this.options=(l.__runInitializers(this,Vt),l.__runInitializers(this,xt,void 0)),this.historyMuted=(l.__runInitializers(this,Pt),l.__runInitializers(this,Rt,!1)),this.serviceApi=(l.__runInitializers(this,Lt),{loadData:h=>this.loadData(h),reject:()=>this.reject(),commit:()=>this.commit(),commitField:h=>this.commitField(h),toInit:()=>this.toInit(),undo:()=>this.undo(),redo:()=>this.redo(),goToHistory:h=>this.goToHistory(h)}),this.options=r,this[J.immerable]=!0,this.init(t),this.autoAttachDevtools(),this.initLegacyFields()}resetToDefault(){this.modified_={},this.committedData={},this.changes=[],this.inverseChanges=[],this.history=[],this.historyIndex=-1}initValidation(t){if(t)Reflect.get(this.validation,t);else for(const r in this.validation)this.validation[r]}init(t={}){this.cloneForInit(t),this.resetToDefault(),this.createDraft(t),this.defineData(this.initData)}initField(t,r){const h=N.fieldInstance(t,this);if(h){t in this.initData||Reflect.set(this.initData,t,V.cloneDeep(Reflect.get(this,t)));const f=V.cloneDeep(this.initData),m=h?.factory?h.factory(f,this):Reflect.get(f,h.name);this.defineFieldValue(t,m),r?.skipValidation||this.initValidation(t),this.getInitializedFields().add(String(t))}}getInitializedFields(){return this.initializedFields||(this.initializedFields=new Set),this.initializedFields}initLegacyFields(){var t;if(this.legacyInitDone)return;const r=N.fields(this);if(!r.some(O=>Object.prototype.hasOwnProperty.call(this,O.name)))return;this.legacyInitDone=!0;const f=this.getInitializedFields(),m=(t=this.rawInitData)!==null&&t!==void 0?t:this.initData;if(m&&m!==this.initData)try{this.initData=V.cloneDeep(m)}catch{this.initData=Object.assign({},m)}for(const O of r){const b=String(O.name);if(m&&b in m){const F=N.fieldInstance(b,this);if(!F)continue;if(!f.has(b)){const W=V.cloneDeep(m),et=F.factory?F.factory(W,this):Reflect.get(W,F.name);this.defineFieldValue(b,et),Reflect.set(this,b,et),f.add(b)}continue}f.has(b)||this.initField(b,{skipValidation:!0})}}createDraft(t){const r={};for(const h in t)N.fieldInstance(h,this)&&Reflect.set(r,h,V.cloneDeep(t[h]));this.draft=J.createDraft(r)}autoAttachDevtools(){var t,r,h,f,m,O,b,k,F,W,et,rt;const ot=globalThis;if(!ot.__MVVM_DEVTOOLS_AUTO__||((r=(t=this.options)===null||t===void 0?void 0:t.devtools)===null||r===void 0?void 0:r.enabled)===!1)return;const Xt=(b=(m=(f=(h=this.options)===null||h===void 0?void 0:h.devtools)===null||f===void 0?void 0:f.name)!==null&&m!==void 0?m:(O=this.constructor)===null||O===void 0?void 0:O.name)!==null&&b!==void 0?b:"Model",Qt=((k=ot.__MVVM_DEVTOOLS_SEQ__)!==null&&k!==void 0?k:0)+1;ot.__MVVM_DEVTOOLS_SEQ__=Qt;const le=(et=(W=(F=this.options)===null||F===void 0?void 0:F.devtools)===null||W===void 0?void 0:W.instanceId)!==null&&et!==void 0?et:`${Xt}#${Qt}`;((rt=globalThis.queueMicrotask)!==null&&rt!==void 0?rt:(ce=>Promise.resolve().then(ce)))(()=>ne(this,{name:Xt,instanceId:le}))}withHistoryMuted(t){this.historyMuted=!0;try{t()}finally{this.historyMuted=!1}}syncChangesFromHistory(){const t=this.historyIndex>=0?this.history.slice(0,this.historyIndex+1):[];this.changes=t.flatMap(r=>r.patches),this.inverseChanges=t.flatMap(r=>r.inversePatches)}applyHistoryPatches(t){if(!t.length)return;J.applyPatches(this.draft,t);const r=new Set(t.map(h=>h.field).filter(Boolean));r.size!==0&&this.withHistoryMuted(()=>{for(const h of r){const f=this.draft,m=this.initData,O=Reflect.has(f,h),b=Reflect.get(O?f:m,h);let k=b;try{k=V.cloneDeep(b)}catch{k=b}Reflect.set(this,h,k),this.defineFieldValue(h,Reflect.get(this,h))}})}produceDraft(t,r,h){if(this.historyMuted)return;let f,m=[];t&&(f=t.split(".")[0],f&&!N.fieldInstance(f,this).collectChanges)||(J.produce(this.draft,O=>{if(t){let b=O;const k=t.split(".");if(k.length>1)for(let F=0;F<k.length&&!(!(F==k.length-1)&&!V.isObject(b));F++)V.isObject(b)&&(b=b[k[F]]);else h=t;b&&(b[h]=r)}},(O,b)=>{f&&(O=O.map(k=>Object.assign(Object.assign({},k),{field:f})),b=b.map(k=>Object.assign(Object.assign({},k),{field:f}))),m=O,!(!O.length&&!b.length)&&(this.historyIndex<this.history.length-1&&(this.history=this.history.slice(0,this.historyIndex+1),this.syncChangesFromHistory()),this.changes.push(...O),this.inverseChanges.push(...b),this.history.push({patches:O,inversePatches:b}),this.historyIndex=this.history.length-1)}),m.length&&J.applyPatches(this.draft,m))}createObservable(t,r,h,f=h){return t=y.isObservable(t)?t:y.observable.box(t),new Proxy(t.get(),{get:(m,O,b)=>{const k=Reflect.get(m,O,b);return k&&typeof k=="object"&&!(k instanceof e)&&!y.isObservable(t)?this.createObservable(k,String(O),r,`${f}.${String(O)}`):k},set:(m,O,b,k)=>{const F=Reflect.set(m,O,b,k);return t.set(b),this.produceDraft(f,t.get(),String(O)),this.checkChange(h,Reflect.get(this,h)),F}})}defineFieldValue(t,r){const h=N.fieldInstance(t,this);return r&&typeof r=="object"&&(r=this.createObservable(r,t,t)),r=y.observable.box(r),Reflect.defineProperty(this,h.name,{get(){return r.get()},set:f=>{y.runInAction(()=>r.set(f)),this.produceDraft(h.name,r.get()),this.checkChange(h.name,r.get())},enumerable:!0,configurable:!0}),r}cloneForInit(t){if(t)try{const r=V.cloneDeep(t);this.initData=r,this.rawInitData=r}catch{const h=Object.assign({},t);this.initData=h,this.rawInitData=h}else this.rawInitData=null}checkChange(t,r){const h=V.cloneDeep(r),f=V.cloneDeep(Reflect.get(this.committedData,t))||V.cloneDeep(Reflect.get(this.initData,t)),m=t&&t in this.initData&&!V.isEqual(f,h);return y.runInAction(()=>{m&&Reflect.set(this.modified_,t,V.cloneDeep(f)||f);for(const O in this.modified_)t===O&&t in this.modified_&&V.isEqual(f,h)&&delete this.modified_[O]}),m}defineData(t){for(const r in this){if(!Object.prototype.hasOwnProperty.call(this,r))continue;N.fieldInstance(r,this)&&(Reflect.set(this,r,Reflect.get(t,r)),this.initField(r))}}get dirty(){return!V.isEmpty(this.modified_)}commit(){for(const t of N.fields(this))this.commitField(t.name);this.modified_={}}commitField(t){for(const r in this)r in this.modified_&&Reflect.set(this.committedData,r,this[r]);delete this.modified_[t],this.modified_=Object.assign({},this.modified_)}reject(){for(const t in this)t in this.modified_&&(this[t]=Reflect.get(this.modified_,t),this.commitField(t),this.defineFieldValue(t,this[t]));this.commit()}toInit(){return this.withHistoryMuted(()=>{for(const t in this)if(t in this.initData){const r=Reflect.get(this.initData,t);this[t]=r,this.initField(t)}this.init(this.initData)}),this}undo(){if(this.historyIndex<0)return;const t=this.history[this.historyIndex];this.historyIndex-=1,this.applyHistoryPatches(t.inversePatches),this.syncChangesFromHistory()}redo(){if(this.historyIndex>=this.history.length-1)return;const t=this.historyIndex+1,r=this.history[t];this.historyIndex=t,this.applyHistoryPatches(r.patches),this.syncChangesFromHistory()}goToHistory(t){if(!(t<-1||t>=this.history.length)&&t!==this.historyIndex){for(;this.historyIndex<t;){const r=this.historyIndex+1,h=this.history[r];this.historyIndex=r,this.applyHistoryPatches(h.patches)}for(;this.historyIndex>t;){const r=this.history[this.historyIndex];this.historyIndex-=1,this.applyHistoryPatches(r.inversePatches)}this.syncChangesFromHistory()}}loadData(t){return this.withHistoryMuted(()=>{this.init(t),this.defineData(this.initData)}),this}get dumpData(){this.initLegacyFields();const t=Object.create({}),r=f=>{const m=Ve.fieldInstance(f,this);return m?.callback?m.callback(Reflect.get(this,f),this):Reflect.get(this,f)},h=f=>{const m=xe.fieldInstance(f,this);if(m)switch(typeof m.callback){case"boolean":return!!m.callback;case"function":return m.callback(Reflect.get(this,f),this)}return!1};N.fields(this).forEach(f=>{var m;if(f.name in this)return!((m=this.options)===null||m===void 0)&&m.byFields&&!this.options.byFields.includes(f.name)||h(f.name)?void 0:Reflect.set(t,f.name,r(f.name))});try{return V.cloneDeep(t)}catch{return t&&Object.assign({},t)}}get validation(){this.initLegacyFields();const t={};for(const r in this){const h=Fe.fieldInstance(r,this);h&&Reflect.set(t,r,h.callback(this[r],this)||"")}return t}get validAndDirty(){return this.dirty&&Object.values(this.validation).filter(Boolean).length===0}get service(){return Object.assign({dirty:this.dirty,dumpData:this.dumpData,validation:this.validation,changes:this.changes,inverseChanges:this.inverseChanges,history:this.history,historyIndex:this.historyIndex},this.serviceApi)}},a=new WeakMap,u=new WeakMap,o=new WeakMap,i=new WeakMap,s=new WeakMap,n=new WeakMap,d=new WeakMap,g=[E],_=l.__propKey(J.immerable),(()=>{const I=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;A=[y.observable,E],Y=[y.observable,E],w=[y.observable,E],z=[E],j=[y.observable,E],$=[y.observable,E],st=[y.observable,E],pt=[y.observable,E],Ot=[E],kt=[E],At=[E],Ft=[E],jt=[y.action],Et=[E],Ct=[y.action],Ht=[y.computed],Kt=[y.action],Gt=[y.action],Yt=[y.action],Bt=[y.action],Nt=[y.action],Ut=[y.action],qt=[y.action],$t=[y.computed],Wt=[y.computed],Jt=[(v=y.computed).struct.bind(v)],l.__esDecorate(e,null,A,{kind:"accessor",name:"initData",static:!1,private:!1,access:{has:t=>"initData"in t,get:t=>t.initData,set:(t,r)=>{t.initData=r}},metadata:I},L,K),l.__esDecorate(e,null,Y,{kind:"accessor",name:"committedData",static:!1,private:!1,access:{has:t=>"committedData"in t,get:t=>t.committedData,set:(t,r)=>{t.committedData=r}},metadata:I},Z,B),l.__esDecorate(e,null,w,{kind:"accessor",name:"modified_",static:!1,private:!1,access:{has:t=>"modified_"in t,get:t=>t.modified_,set:(t,r)=>{t.modified_=r}},metadata:I},c,M),l.__esDecorate(e,null,j,{kind:"accessor",name:"changes",static:!1,private:!1,access:{has:t=>"changes"in t,get:t=>t.changes,set:(t,r)=>{t.changes=r}},metadata:I},C,q),l.__esDecorate(e,null,$,{kind:"accessor",name:"inverseChanges",static:!1,private:!1,access:{has:t=>"inverseChanges"in t,get:t=>t.inverseChanges,set:(t,r)=>{t.inverseChanges=r}},metadata:I},tt,it),l.__esDecorate(e,null,st,{kind:"accessor",name:"history",static:!1,private:!1,access:{has:t=>"history"in t,get:t=>t.history,set:(t,r)=>{t.history=r}},metadata:I},at,bt),l.__esDecorate(e,null,pt,{kind:"accessor",name:"historyIndex",static:!1,private:!1,access:{has:t=>"historyIndex"in t,get:t=>t.historyIndex,set:(t,r)=>{t.historyIndex=r}},metadata:I},Dt,It),l.__esDecorate(e,null,jt,{kind:"method",name:"resetToDefault",static:!1,private:!1,access:{has:t=>"resetToDefault"in t,get:t=>t.resetToDefault},metadata:I},null,p),l.__esDecorate(e,null,Ct,{kind:"method",name:"produceDraft",static:!1,private:!1,access:{has:t=>"produceDraft"in t,get:t=>t.produceDraft},metadata:I},null,p),l.__esDecorate(e,null,Ht,{kind:"getter",name:"dirty",static:!1,private:!1,access:{has:t=>"dirty"in t,get:t=>t.dirty},metadata:I},null,p),l.__esDecorate(e,null,Kt,{kind:"method",name:"commit",static:!1,private:!1,access:{has:t=>"commit"in t,get:t=>t.commit},metadata:I},null,p),l.__esDecorate(e,null,Gt,{kind:"method",name:"commitField",static:!1,private:!1,access:{has:t=>"commitField"in t,get:t=>t.commitField},metadata:I},null,p),l.__esDecorate(e,null,Yt,{kind:"method",name:"reject",static:!1,private:!1,access:{has:t=>"reject"in t,get:t=>t.reject},metadata:I},null,p),l.__esDecorate(e,null,Bt,{kind:"method",name:"toInit",static:!1,private:!1,access:{has:t=>"toInit"in t,get:t=>t.toInit},metadata:I},null,p),l.__esDecorate(e,null,Nt,{kind:"method",name:"undo",static:!1,private:!1,access:{has:t=>"undo"in t,get:t=>t.undo},metadata:I},null,p),l.__esDecorate(e,null,Ut,{kind:"method",name:"redo",static:!1,private:!1,access:{has:t=>"redo"in t,get:t=>t.redo},metadata:I},null,p),l.__esDecorate(e,null,qt,{kind:"method",name:"goToHistory",static:!1,private:!1,access:{has:t=>"goToHistory"in t,get:t=>t.goToHistory},metadata:I},null,p),l.__esDecorate(e,null,$t,{kind:"getter",name:"validation",static:!1,private:!1,access:{has:t=>"validation"in t,get:t=>t.validation},metadata:I},null,p),l.__esDecorate(e,null,Wt,{kind:"getter",name:"validAndDirty",static:!1,private:!1,access:{has:t=>"validAndDirty"in t,get:t=>t.validAndDirty},metadata:I},null,p),l.__esDecorate(e,null,Jt,{kind:"getter",name:"service",static:!1,private:!1,access:{has:t=>"service"in t,get:t=>t.service},metadata:I},null,p),l.__esDecorate(null,null,g,{kind:"field",name:_,static:!1,private:!1,access:{has:t=>_ in t,get:t=>t[_],set:(t,r)=>{t[_]=r}},metadata:I},D,S),l.__esDecorate(null,null,z,{kind:"field",name:"draft",static:!1,private:!1,access:{has:t=>"draft"in t,get:t=>t.draft,set:(t,r)=>{t.draft=r}},metadata:I},x,T),l.__esDecorate(null,null,Ot,{kind:"field",name:"initializedFields",static:!1,private:!1,access:{has:t=>"initializedFields"in t,get:t=>t.initializedFields,set:(t,r)=>{t.initializedFields=r}},metadata:I},Mt,St),l.__esDecorate(null,null,kt,{kind:"field",name:"legacyInitDone",static:!1,private:!1,access:{has:t=>"legacyInitDone"in t,get:t=>t.legacyInitDone,set:(t,r)=>{t.legacyInitDone=r}},metadata:I},wt,zt),l.__esDecorate(null,null,At,{kind:"field",name:"rawInitData",static:!1,private:!1,access:{has:t=>"rawInitData"in t,get:t=>t.rawInitData,set:(t,r)=>{t.rawInitData=r}},metadata:I},Tt,Vt),l.__esDecorate(null,null,Ft,{kind:"field",name:"options",static:!1,private:!1,access:{has:t=>"options"in t,get:t=>t.options,set:(t,r)=>{t.options=r}},metadata:I},xt,Pt),l.__esDecorate(null,null,Et,{kind:"field",name:"historyMuted",static:!1,private:!1,access:{has:t=>"historyMuted"in t,get:t=>t.historyMuted,set:(t,r)=>{t.historyMuted=r}},metadata:I},Rt,Lt),I&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:I})})(),e})();const re=Symbol("store-key"),je=()=>{var e;return(e=globalThis.__REDUX_DEVTOOLS_EXTENSION__)!==null&&e!==void 0?e:null},Ee=()=>{var e;return(e=globalThis.__MVVM_DEVTOOLS_APPLYING__)!==null&&e!==void 0?e:0},Re=e=>{var a,u;const o=globalThis;o.__MVVM_DEVTOOLS_APPLYING__=((a=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&a!==void 0?a:0)+1;try{return e()}finally{o.__MVVM_DEVTOOLS_APPLYING__=Math.max(0,((u=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&u!==void 0?u:1)-1)}},Le=()=>Ee()>0,vt=e=>({items:e.items.map(a=>{var u,o;return{name:(o=(u=a.constructor)===null||u===void 0?void 0:u.name)!==null&&o!==void 0?o:"Model",data:a.service.dumpData,historyIndex:a.service.historyIndex}})}),Ce=e=>!!(e&&typeof e=="object"&&Array.isArray(e.items)),He=e=>{if(!e)return null;try{const a=JSON.parse(e);return Ce(a)?a:null}catch{return null}},oe=(e,a={})=>{var u,o;const i=je();if(!i)return()=>{};const s=i.connect({name:a.name,instanceId:a.instanceId});let n=!1,d=(o=(u=e.items[0])===null||u===void 0?void 0:u.constructor)!==null&&o!==void 0?o:null;try{s.init(vt(e))}catch{}const _=y.reaction(()=>vt(e),g=>{var D;if(n||Le())return;const S=(D=e.items[0])===null||D===void 0?void 0:D.constructor;S&&(d=S);try{s.send({type:"store:update"},g)}catch{}}),v=g=>(n=!0,Re(()=>{try{return g()}finally{n=!1}})),p=s.subscribe(g=>{var D;if(g.type!=="DISPATCH")return;const S=(D=g.payload)===null||D===void 0?void 0:D.type;if(S==="RESET"||S==="ROLLBACK"){v(()=>e.reset());return}if(S==="JUMP_TO_ACTION"||S==="JUMP_TO_STATE"){const A=He(g.state);if(!A)return;v(()=>{var L,K,Y;if(A.items.length===e.items.length&&e.items.every(M=>{var z,x;return typeof((z=M?.service)===null||z===void 0?void 0:z.goToHistory)=="function"||typeof((x=M?.service)===null||x===void 0?void 0:x.loadData)=="function"})){y.runInAction(()=>{A.items.forEach((M,z)=>{var x;const T=(x=e.items[z])===null||x===void 0?void 0:x.service,j=M.historyIndex,C=T?.history;if(Array.isArray(C)&&C.length>0&&typeof j=="number"&&typeof T?.goToHistory=="function"&&(j===-1&&C.length>0||j<C.length)){T.goToHistory(j);return}typeof T?.loadData=="function"&&T.loadData(M.data)})});return}const B=(K=(L=e.items[0])===null||L===void 0?void 0:L.constructor)!==null&&K!==void 0?K:d,w=A.items.map(M=>M.data);if(B){e.applyLoaded(w,{model:B,cash:!1}),d=B;return}e.applyLoaded(w,{cash:!1});const c=(Y=e.items[0])===null||Y===void 0?void 0:Y.constructor;c&&(d=c)})}});return()=>{_(),typeof p=="function"&&p(),typeof s.unsubscribe=="function"&&s.unsubscribe(),typeof s.disconnect=="function"&&s.disconnect()}};let Ke=(()=>{var e,a,u;let o=[],i,s=[],n=[],d,_=[],v=[],p,g,D,S,A,L,K,Y,Z,B;return e=class{get items(){return l.__classPrivateFieldGet(this,a,"f")}set items(c){l.__classPrivateFieldSet(this,a,c,"f")}get _cash(){return l.__classPrivateFieldGet(this,u,"f")}set _cash(c){l.__classPrivateFieldSet(this,u,c,"f")}constructor(){a.set(this,(l.__runInitializers(this,o),l.__runInitializers(this,s,[]))),u.set(this,(l.__runInitializers(this,n),l.__runInitializers(this,_,[]))),l.__runInitializers(this,v),y.makeObservable(this),this.autoAttachDevtools()}add(c){this.items=this.items.concat(c)}addMany(c){c?.length&&(this.items=this.items.concat(c))}remove(c){this.items=this.items.filter(M=>M!==c)}find(c){return this.items.find(c)}filter(c){return this.items.filter(c)}findBy(c,M){return this.items.find(z=>z?.[c]===M)}clear(){this.items=[]}get size(){return this.items.length}get snapshot(){return vt(this)}get cash(){return this._cash}reset(){this.clear()}applyLoaded(c,M={}){const{model:z,mode:x="replace",cash:T=!0}=M;if(T&&this.setCash(c),x==="append"){const j=z?c.map(C=>new z(C)):c;this.addMany(j);return}this.items=z?c.map(j=>new z(j)):c}setCash(c){this._cash=c??[]}autoAttachDevtools(){var c,M,z,x,T,j,C,q;const $=globalThis;if(!$.__MVVM_DEVTOOLS_AUTO__)return;const tt=R(re,this.constructor,{})||{};if(((c=tt.devtools)===null||c===void 0?void 0:c.enabled)===!1)return;const it=(T=(z=(M=tt.devtools)===null||M===void 0?void 0:M.name)!==null&&z!==void 0?z:(x=this.constructor)===null||x===void 0?void 0:x.name)!==null&&T!==void 0?T:"Store",st=((j=$.__MVVM_DEVTOOLS_STORE_SEQ__)!==null&&j!==void 0?j:0)+1;$.__MVVM_DEVTOOLS_STORE_SEQ__=st;const at=(q=(C=tt.devtools)===null||C===void 0?void 0:C.instanceId)!==null&&q!==void 0?q:`${it}#${st}`;oe(this,{name:it,instanceId:at})}},a=new WeakMap,u=new WeakMap,(()=>{const w=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;i=[y.observable],d=[y.observable],p=[y.action],g=[y.action],D=[y.action],S=[y.action],A=[y.computed],L=[y.computed],K=[y.computed],Y=[y.action],Z=[y.action],B=[y.action],l.__esDecorate(e,null,i,{kind:"accessor",name:"items",static:!1,private:!1,access:{has:c=>"items"in c,get:c=>c.items,set:(c,M)=>{c.items=M}},metadata:w},s,n),l.__esDecorate(e,null,d,{kind:"accessor",name:"_cash",static:!1,private:!1,access:{has:c=>"_cash"in c,get:c=>c._cash,set:(c,M)=>{c._cash=M}},metadata:w},_,v),l.__esDecorate(e,null,p,{kind:"method",name:"add",static:!1,private:!1,access:{has:c=>"add"in c,get:c=>c.add},metadata:w},null,o),l.__esDecorate(e,null,g,{kind:"method",name:"addMany",static:!1,private:!1,access:{has:c=>"addMany"in c,get:c=>c.addMany},metadata:w},null,o),l.__esDecorate(e,null,D,{kind:"method",name:"remove",static:!1,private:!1,access:{has:c=>"remove"in c,get:c=>c.remove},metadata:w},null,o),l.__esDecorate(e,null,S,{kind:"method",name:"clear",static:!1,private:!1,access:{has:c=>"clear"in c,get:c=>c.clear},metadata:w},null,o),l.__esDecorate(e,null,A,{kind:"getter",name:"size",static:!1,private:!1,access:{has:c=>"size"in c,get:c=>c.size},metadata:w},null,o),l.__esDecorate(e,null,L,{kind:"getter",name:"snapshot",static:!1,private:!1,access:{has:c=>"snapshot"in c,get:c=>c.snapshot},metadata:w},null,o),l.__esDecorate(e,null,K,{kind:"getter",name:"cash",static:!1,private:!1,access:{has:c=>"cash"in c,get:c=>c.cash},metadata:w},null,o),l.__esDecorate(e,null,Y,{kind:"method",name:"reset",static:!1,private:!1,access:{has:c=>"reset"in c,get:c=>c.reset},metadata:w},null,o),l.__esDecorate(e,null,Z,{kind:"method",name:"applyLoaded",static:!1,private:!1,access:{has:c=>"applyLoaded"in c,get:c=>c.applyLoaded},metadata:w},null,o),l.__esDecorate(e,null,B,{kind:"method",name:"setCash",static:!1,private:!1,access:{has:c=>"setCash"in c,get:c=>c.setCash},metadata:w},null,o),w&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:w})})(),e})();function Ge(e){return U(e,"instance")}function Ye(e){return((a,u)=>ae(e)(a,u))}function Be(e,a){const u=(o,i)=>{var s;const n=typeof e=="string"?{id:e}:typeof e=="object"?e:{id:(s=i?.name)!==null&&s!==void 0?s:o?.name};P(re,n,o),gt(n)(o,i)};return typeof e=="function"?u(e,a):(o,i)=>u(o,i)}class Ne{}const dt=new mt;function Ue(e,a){return de.observer((u={})=>{const{resolved:o,instance:i}=Zt.useMemo(()=>{const n=U(e)||(typeof e!="string"?{instance:new e}:void 0),d=n?.instance;return{resolved:n,instance:d}},[e]);if(Zt.useEffect(()=>{if(i)return typeof i.onInit=="function"&&i.onInit(),()=>{typeof i.onDispose=="function"&&i.onDispose()}},[i]),o){const s=dt.fields(i),n=s.length>0?s:dt.fields(Object.getPrototypeOf(i));for(const d in u)if(n instanceof Array){const _=n.find(v=>v.name===d);_&&Reflect.set(i,_.originName,Reflect.get(u,d))}return P(dt.metadataKey,n,i),a(Object.assign({viewModel:i},u))}return a(Object.assign({},u))})}exports.GetService=U;exports.GetStore=Ge;exports.Inject=ae;exports.InjectStore=Ye;exports.MakeObservable=we;exports.Model=Pe;exports.PropFromView=ke;exports.Service=gt;exports.SetService=fe;exports.Store=Be;exports.StoreBase=Ke;exports.TODO=he;exports.ViewModel=Ne;exports.attachModelDevtools=ne;exports.attachStoreDevtools=oe;exports.defineMetadata=P;exports.define_prop=E;exports.exclude=Me;exports.field=Se;exports.getExecutingFunctionNameByStack=se;exports.getOwnMetadata=R;exports.isSerializable=ue;exports.submit=Oe;exports.validation=Ie;exports.view=Ue;
//# sourceMappingURL=index.cjs.map
