"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});require("reflect-metadata");const l=require("./tslib.es6-DqNExo46.cjs"),V=require("lodash"),y=require("mobx"),X=require("immer"),de=require("mobx-react"),Zt=require("react"),j=(e,a,d)=>Reflect.getOwnMetadata(e,a)||d||{},P=(e,a,d)=>Reflect.defineMetadata(e,a,d);function he(...e){try{return JSON.stringify(e),!0}catch{return!1}}function se(e){if(e&&typeof e=="string"){let[a]=e.split(`
`)[2].replace(/at (get)?/,"").match(/.*/g)||[];return a&&(a=a.trim()),a}}const te={},ot=[];let ee=!1;const ue=(e,...a)=>{const d=new Error().stack;if(!ee)console.log("%c TODO","background: #222; color: #bada55",te),ee=!0;else{const i=se(d);ot.includes(i)===!1&&(ot.push(i),Reflect.set(te,`${ot.length}) ${e}`,{msg:a,get path(){return console.info(a,i),i}}))}function o(...i){}return o},Y=(e,a)=>!!e&&(typeof a=="string"||typeof a=="symbol"),C=e=>!!e&&typeof e=="object"&&"kind"in e,fe=e=>({kind:"class",name:e,addInitializer:()=>{},metadata:{}}),Q=Symbol("service-key"),dt=new Proxy({},Reflect);function ae(e){const a=(o,i)=>{Object.defineProperty(o,i,{configurable:!0,enumerable:!0,get(){if(Object.prototype.hasOwnProperty.call(this,i))return Reflect.get(this,i);const s=q(e,"instance");if(s)return Object.defineProperty(this,i,{value:s,writable:!0,configurable:!0,enumerable:!0}),s},set(s){const n=q(e,"instance");Object.defineProperty(this,i,{value:n??s,writable:!0,configurable:!0,enumerable:!0})}})};function d(o,i){if(Y(o,i)){a(o,i);return}return i.addInitializer(function(){return l.__awaiter(this,void 0,void 0,function*(){const s=q(e,"instance");s&&Object.hasOwn(this,i.name)&&Reflect.set(this,i.name,s)})}),s=>s}return d}function q(e,a){var d;const o=j(Q,dt);if(typeof e!="string"){const i=j(Q,e);if(i)return a&&a in i?i[a]:i;for(const s in o){const n=o[s];if(n.target===e){e=n.context.name;break}}}if(typeof e=="string")return a?(d=o[e])===null||d===void 0?void 0:d[a]:o[e]}function vt(e,a){const d=(i,s)=>{const n=String(typeof e=="string"&&e||typeof e=="object"&&e?.id||s?.name||i?.name),c=j(Q,dt),u=new Proxy({target:i,instance:typeof e=="object"&&Reflect.get(e,"transient")||typeof e=="object"&&Reflect.get(e,"lazy")?i:new i,context:s,options:e},{get(v,p,g){var D,M;if(p==="instance"&&(!((D=v?.options)===null||D===void 0)&&D.transient))return new i;if(p==="instance"&&(!((M=v?.options)===null||M===void 0)&&M.lazy)&&v.instance===i){const T=new i;return Reflect.set(v,p,T,g),T}return Reflect.get(v,p,g)},set(v,p,g,D){return Reflect.set(v,p,g,D)}});c[n]=u,P(Q,c,dt),P(Q,c[n],i)};function o(i,s){var n,c;const u=i.__mvvm_legacy_source__,v=C(s)?s:fe((c=(n=u?.name)!==null&&n!==void 0?n:i?.name)!==null&&c!==void 0?c:"");d(i,v),u&&u!==i&&P(Q,j(Q,i),u)}return V.isFunction(e)?o(e,a):e?(i,s)=>o(i,s):o}const _e=(e,a)=>{const{kind:d="class",name:o="",addInitializer:i=()=>{},metadata:s}=a?.ctx||{};return vt(a)(e,{kind:d,name:o,addInitializer:i,metadata:s}),q(e).instance},ye=Symbol("field-key"),me=Symbol("validation-key"),ve=Symbol("submit-key"),ge=Symbol("exclude-key"),be=Symbol("prop-from-view-key");class Z{constructor(a={}){this.metadataKey=null,this.name=a?.name,this.callback=a?.callback}isInstance(a={}){return a instanceof Z||Object.getOwnPropertyNames(this).some(d=>Object.keys(a).includes(d))}fieldInstance(a,d){return this.fields(d).find(o=>o.name===a)}fields(a){const d=[],o=new Set;let i=a;for(;i;){const s=Reflect.getOwnMetadata(this.metadataKey,i);if(Array.isArray(s))for(const n of s){const c=n?.name;if(c!==void 0){const u=typeof c=="symbol"?c:String(c);if(o.has(u))continue;o.add(u)}d.push(n)}i=Object.getPrototypeOf(i)}return d}}class ht extends Z{constructor(){super(...arguments),this.metadataKey=me}}class ut extends Z{constructor(){super(...arguments),this.metadataKey=ve}}class ft extends Z{constructor(){super(...arguments),this.metadataKey=ge}}class _t extends Z{constructor(a={}){super(a),this.factory=null,this.mapping=null,this.collectChanges=!1,this.name=null,this.ctx=null,this.metadataKey=ye,this.factory=a.factory,this.mapping=a.mapping,this.name=a.name,this.ctx=a.ctx,this.collectChanges=!!a.collectChanges}}class yt extends Z{constructor(a={}){super(a),this.metadataKey=be;for(const d in this)a&&d in a&&(this[d]=Reflect.get(a,d))}}function lt(e){const a=Object.assign({enumerable:!1,writable:!0},e);return function(d,o){if(Y(d,o)){Object.defineProperty(d,o,{configurable:!0,enumerable:a.enumerable,get(){},set(i){Object.defineProperty(this,o,Object.assign({value:i},a))}});return}if(C(o)){const i=o;return i.kind==="field"?function(s){return Object.defineProperty(this,i.name,Object.assign({value:s},a)),s}:(i.addInitializer(function(){const s=Object.getOwnPropertyDescriptor(this,i.name);s&&Object.defineProperty(this,i.name,Object.assign(Object.assign({},s),{enumerable:a.enumerable}))}),d)}}}function E(e,a){return Y(e,a)||C(a)?lt()(e,a):lt(e)}const pe=()=>{var e;const a=globalThis;return!!((e=a.__MVVM_DEVTOOLS_HISTORY__)!==null&&e!==void 0?e:a.__MVVM_DEVTOOLS_AUTO__)},De=e=>pe()?!e||typeof e!="object"?{collectChanges:!0}:"collectChanges"in e?e:Object.assign(Object.assign({},e),{collectChanges:!0}):e;function Ie(e){const a=(i,s)=>{const n=new ht({callback:e,name:String(s)}),c=j(n.metadataKey,i,new Array);P(n.metadataKey,[...c,n],i)},d=i=>{i.addInitializer(function(){const s=new ht({callback:e,name:String(i.name)}),n=j(s.metadataKey,this,new Array);P(s.metadataKey,[...n,s],this)})};function o(i,s){if(Y(i,s)){a(i,s);return}if(C(s))return d(s),s.kind==="field"?n=>n:s}return e?((i,s)=>o(i,s)):(i=>i)}function Oe(e){const a=(i,s)=>{const n=new ut({callback:e,name:String(s)}),c=j(n.metadataKey,i,new Array);P(n.metadataKey,[...c,n],i)},d=i=>{i.addInitializer(function(){const s=new ut({callback:e,name:String(i.name)}),n=j(s.metadataKey,this,new Array);P(s.metadataKey,[...n,s],this)})};function o(i,s){if(Y(i,s)){a(i,s);return}if(C(s))return d(s),s.kind==="field"?n=>n:s}return e?((i,s)=>o(i,s)):(i=>i)}function Se(e){const a=(i,s)=>{const n=new ft({callback:e,name:String(s)}),c=j(n.metadataKey,i,new Array);P(n.metadataKey,[...c,n],i)},d=i=>{i.addInitializer(function(){const s=new ft({callback:e,name:String(i.name)}),n=j(s.metadataKey,this,new Array);P(s.metadataKey,[...n,s],this)})};function o(i,s){if(Y(i,s)){a(i,s);return}if(C(s))return d(s),s.kind==="field"?void 0:s}if(e)return((i,s)=>o(i,s))}function Me(e,a){const d=De(Y(e,a)?void 0:e),o=(n,c)=>{const u=new _t(Object.assign(Object.assign({},d),{name:String(c),ctx:null})),v=j(u.metadataKey,n,new Array);P(u.metadataKey,[...v,u],n),Object.getOwnPropertyDescriptor(n,c)||Object.defineProperty(n,c,{configurable:!0,enumerable:!0,get(){const g=this;if(Object.prototype.hasOwnProperty.call(g,c))return Reflect.get(g,c);const D=g.initField,M=g.initData;if(M&&c in M&&typeof D=="function")return D.call(g,String(c),{skipValidation:!0}),Reflect.get(g,c)},set(g){const D=this,M=D.initField,T=D.initData;if(T&&!(c in T)&&Reflect.set(T,c,g),typeof M=="function"){M.call(D,String(c),{skipValidation:!0});return}Object.defineProperty(this,c,{value:g,writable:!0,configurable:!0,enumerable:!0})}})},i=n=>{n.addInitializer(function(){const c=this;if(typeof c.initField=="function"){const u=new _t(Object.assign(Object.assign({},d),{name:String(n.name),ctx:n})),v=j(u.metadataKey,this,new Array);P(u.metadataKey,[...v,u],this),c.initField.call(this,String(n.name))}})};function s(n,c){if(Y(n,c)){o(n,c);return}if(C(c))return i(c),c.kind==="field"?u=>u:c}return Y(e,a)?s(e,a):d&&!C(a)?(n,c)=>s(n,c):C(a)?s(void 0,a):(n,c)=>s(n,c)}function ke(e){const a=(i,s)=>{const n=new yt({name:e,originName:String(s)});n.name=e,n.originName=String(s);const c=j(n.metadataKey,i,new Array);P(n.metadataKey,[...c,n],i)},d=i=>{i.addInitializer(function(){const s=new yt,n=s.fields(this);for(const c in this)n instanceof Array&&i.name===c&&(s.name=e,s.originName=c,s.value=this[c],n.push(s));P(s.metadataKey,n,this)})};function o(i,s){if(Y(i,s)){a(i,s);return}if(C(s))return d(s),s.kind==="field"?n=>n:s}return e?((i,s)=>o(i,s)):(i=>i)}function we(e,a){const d=s=>class extends s{constructor(...n){super(...n),y.makeObservable(this)}},o=(s,n)=>{if(typeof Reflect?.getOwnMetadataKeys=="function")for(const c of Reflect.getOwnMetadataKeys(s)){const u=Reflect.getOwnMetadata(c,s);Reflect.defineMetadata(c,u,n)}};function i(s,n){if(!C(n)){const c=s,u=d(c);return Object.defineProperty(u,"__mvvm_legacy_source__",{value:c,configurable:!0}),o(c,u),u}n.addInitializer(function(){y.makeObservable(this)})}return e&&!C(a)||e?i(e,a):i}const ze=()=>{var e;return(e=globalThis.__REDUX_DEVTOOLS_EXTENSION__)!==null&&e!==void 0?e:null},Te=()=>{var e;return(e=globalThis.__MVVM_DEVTOOLS_APPLYING__)!==null&&e!==void 0?e:0},nt=e=>{var a,d;const o=globalThis;o.__MVVM_DEVTOOLS_APPLYING__=((a=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&a!==void 0?a:0)+1;try{return e()}finally{o.__MVVM_DEVTOOLS_APPLYING__=Math.max(0,((d=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&d!==void 0?d:1)-1)}},Ae=()=>Te()>0,ie=e=>({data:e.service.dumpData,historyIndex:e.service.historyIndex}),ne=(e,a={})=>{const d=ze();if(!d)return()=>{};const o=d.connect({name:a.name,instanceId:a.instanceId});let i=!1;try{o.init(ie(e))}catch{}const s=y.reaction(()=>ie(e),c=>{var u;if(!(i||Ae()))try{o.send({type:(u=a.actionType)!==null&&u!==void 0?u:"model:update"},c)}catch{}}),n=o.subscribe(c=>{var u;if(c.type!=="DISPATCH")return;const v=(u=c.payload)===null||u===void 0?void 0:u.type;if(v==="RESET"){i=!0,nt(()=>{try{e.service.toInit()}finally{i=!1}});return}if(v==="COMMIT"){i=!0,nt(()=>{try{e.service.commit()}finally{i=!1}});return}if(v==="ROLLBACK"){i=!0,nt(()=>{try{e.service.toInit()}finally{i=!1}});return}if(v==="JUMP_TO_ACTION"||v==="JUMP_TO_STATE"){if(!c.state)return;try{const p=JSON.parse(c.state),g=p.historyIndex,D=e.service.history,M=Array.isArray(D)&&D.length>0,T=typeof g=="number"&&(g===-1&&M||g>=0&&M&&g<D.length);i=!0,nt(()=>{var L;try{if(T){e.service.goToHistory(g);return}const H=(L=p.data)!==null&&L!==void 0?L:p;y.runInAction(()=>{e.service.loadData(H)})}finally{i=!1}})}catch{}}});return()=>{s(),typeof n=="function"&&n(),typeof o.unsubscribe=="function"&&o.unsubscribe(),typeof o.disconnect=="function"&&o.disconnect()}};X.enablePatches();const Ve=new ut,N=new _t,Fe=new ht,xe=new ft;let Pe=(()=>{var e,a,d,o,i,s,n,c,u,v;let p=[],g,D=[],M=[],T,L=[],H=[],B,tt=[],z=[],h,A=[],S=[],R,x=[],w=[],K,G=[],U=[],$,et=[],it=[],at,gt=[],bt=[],pt,Dt=[],It=[],Ot,St=[],Mt=[],kt,wt=[],zt=[],Tt,At=[],Vt=[],Ft,xt=[],Pt=[],Et,jt,Rt=[],Lt=[],Ct,Ht,Kt,Gt,Yt,Bt,Nt,qt,Ut,$t,Wt,Jt;return e=class{get initData(){return l.__classPrivateFieldGet(this,a,"f")}set initData(t){l.__classPrivateFieldSet(this,a,t,"f")}get committedData(){return l.__classPrivateFieldGet(this,d,"f")}set committedData(t){l.__classPrivateFieldSet(this,d,t,"f")}get modified_(){return l.__classPrivateFieldGet(this,o,"f")}set modified_(t){l.__classPrivateFieldSet(this,o,t,"f")}get changes(){return l.__classPrivateFieldGet(this,i,"f")}set changes(t){l.__classPrivateFieldSet(this,i,t,"f")}get inverseChanges(){return l.__classPrivateFieldGet(this,s,"f")}set inverseChanges(t){l.__classPrivateFieldSet(this,s,t,"f")}get history(){return l.__classPrivateFieldGet(this,n,"f")}set history(t){l.__classPrivateFieldSet(this,n,t,"f")}get historyIndex(){return l.__classPrivateFieldGet(this,c,"f")}set historyIndex(t){l.__classPrivateFieldSet(this,c,t,"f")}constructor(t={},r){this[u]=(l.__runInitializers(this,p),l.__runInitializers(this,D,!0)),a.set(this,(l.__runInitializers(this,M),l.__runInitializers(this,L,null))),d.set(this,(l.__runInitializers(this,H),l.__runInitializers(this,tt,{}))),o.set(this,(l.__runInitializers(this,z),l.__runInitializers(this,A,{}))),this.draft=(l.__runInitializers(this,S),l.__runInitializers(this,x,null)),i.set(this,(l.__runInitializers(this,w),l.__runInitializers(this,G,[]))),s.set(this,(l.__runInitializers(this,U),l.__runInitializers(this,et,[]))),n.set(this,(l.__runInitializers(this,it),l.__runInitializers(this,gt,[]))),c.set(this,(l.__runInitializers(this,bt),l.__runInitializers(this,Dt,-1))),this.initializedFields=(l.__runInitializers(this,It),l.__runInitializers(this,St,void 0)),this.legacyInitDone=(l.__runInitializers(this,Mt),l.__runInitializers(this,wt,!1)),this.rawInitData=(l.__runInitializers(this,zt),l.__runInitializers(this,At,null)),this.options=(l.__runInitializers(this,Vt),l.__runInitializers(this,xt,void 0)),this.historyMuted=(l.__runInitializers(this,Pt),l.__runInitializers(this,Rt,!1)),l.__runInitializers(this,Lt),this.options=r,this[X.immerable]=!0,this.init(t),this.autoAttachDevtools(),this.initLegacyFields()}resetToDefault(){this.modified_={},this.committedData={},this.changes=[],this.inverseChanges=[],this.history=[],this.historyIndex=-1}initValidation(t){if(t)Reflect.get(this.validation,t);else for(const r in this.validation)this.validation[r]}init(t={}){this.cloneForInit(t),this.resetToDefault(),this.createDraft(t),this.defineData(this.initData)}initField(t,r){const f=N.fieldInstance(t,this);if(f){t in this.initData||Reflect.set(this.initData,t,V.cloneDeep(Reflect.get(this,t)));const _=V.cloneDeep(this.initData),m=f?.factory?f.factory(_,this):Reflect.get(_,f.name);this.defineFieldValue(t,m),r?.skipValidation||this.initValidation(t),this.getInitializedFields().add(String(t))}}getInitializedFields(){return this.initializedFields||(this.initializedFields=new Set),this.initializedFields}initLegacyFields(){var t;if(this.legacyInitDone)return;const r=N.fields(this);if(!r.some(O=>Object.prototype.hasOwnProperty.call(this,O.name)))return;this.legacyInitDone=!0;const _=this.getInitializedFields(),m=(t=this.rawInitData)!==null&&t!==void 0?t:this.initData;if(m&&m!==this.initData)try{this.initData=V.cloneDeep(m)}catch{this.initData=Object.assign({},m)}for(const O of r){const b=String(O.name);if(m&&b in m){const F=N.fieldInstance(b,this);if(!F)continue;const W=V.cloneDeep(m),J=F.factory?F.factory(W,this):Reflect.get(W,F.name),st=Reflect.get(this,b);(!V.isEqual(st,J)||!_.has(b))&&(this.defineFieldValue(b,J),Reflect.set(this,b,J)),_.add(b);continue}_.has(b)||this.initField(b,{skipValidation:!0})}}createDraft(t){const r={};for(const f in t)N.fieldInstance(f,this)&&Reflect.set(r,f,V.cloneDeep(t[f]));this.draft=X.createDraft(r)}autoAttachDevtools(){var t,r,f,_,m,O,b,k,F,W,J,st;const rt=globalThis;if(!rt.__MVVM_DEVTOOLS_AUTO__||((r=(t=this.options)===null||t===void 0?void 0:t.devtools)===null||r===void 0?void 0:r.enabled)===!1)return;const Xt=(b=(m=(_=(f=this.options)===null||f===void 0?void 0:f.devtools)===null||_===void 0?void 0:_.name)!==null&&m!==void 0?m:(O=this.constructor)===null||O===void 0?void 0:O.name)!==null&&b!==void 0?b:"Model",Qt=((k=rt.__MVVM_DEVTOOLS_SEQ__)!==null&&k!==void 0?k:0)+1;rt.__MVVM_DEVTOOLS_SEQ__=Qt;const le=(J=(W=(F=this.options)===null||F===void 0?void 0:F.devtools)===null||W===void 0?void 0:W.instanceId)!==null&&J!==void 0?J:`${Xt}#${Qt}`;((st=globalThis.queueMicrotask)!==null&&st!==void 0?st:(ce=>Promise.resolve().then(ce)))(()=>ne(this,{name:Xt,instanceId:le}))}withHistoryMuted(t){this.historyMuted=!0;try{t()}finally{this.historyMuted=!1}}syncChangesFromHistory(){const t=this.historyIndex>=0?this.history.slice(0,this.historyIndex+1):[];this.changes=t.flatMap(r=>r.patches),this.inverseChanges=t.flatMap(r=>r.inversePatches)}applyHistoryPatches(t){if(!t.length)return;X.applyPatches(this.draft,t);const r=new Set(t.map(f=>f.field).filter(Boolean));r.size!==0&&this.withHistoryMuted(()=>{for(const f of r){const _=this.draft,m=this.initData,O=Reflect.has(_,f),b=Reflect.get(O?_:m,f);let k=b;try{k=V.cloneDeep(b)}catch{k=b}Reflect.set(this,f,k),this.defineFieldValue(f,Reflect.get(this,f))}})}produceDraft(t,r,f){if(this.historyMuted)return;let _,m=[];t&&(_=t.split(".")[0],_&&!N.fieldInstance(_,this).collectChanges)||(X.produce(this.draft,O=>{if(t){let b=O;const k=t.split(".");if(k.length>1)for(let F=0;F<k.length&&!(!(F==k.length-1)&&!V.isObject(b));F++)V.isObject(b)&&(b=b[k[F]]);else f=t;b&&(b[f]=r)}},(O,b)=>{_&&(O=O.map(k=>Object.assign(Object.assign({},k),{field:_})),b=b.map(k=>Object.assign(Object.assign({},k),{field:_}))),m=O,!(!O.length&&!b.length)&&(this.historyIndex<this.history.length-1&&(this.history=this.history.slice(0,this.historyIndex+1),this.syncChangesFromHistory()),this.changes.push(...O),this.inverseChanges.push(...b),this.history.push({patches:O,inversePatches:b}),this.historyIndex=this.history.length-1)}),m.length&&X.applyPatches(this.draft,m))}createObservable(t,r,f,_=f){return t=y.isObservable(t)?t:y.observable.box(t),new Proxy(t.get(),{get:(m,O,b)=>{const k=Reflect.get(m,O,b);return k&&typeof k=="object"&&!(k instanceof e)&&!y.isObservable(t)?this.createObservable(k,String(O),r,`${_}.${String(O)}`):k},set:(m,O,b,k)=>{const F=Reflect.set(m,O,b,k);return t.set(b),this.produceDraft(_,t.get(),String(O)),this.checkChange(f,Reflect.get(this,f)),F}})}defineFieldValue(t,r){const f=N.fieldInstance(t,this);return r&&typeof r=="object"&&(r=this.createObservable(r,t,t)),r=y.observable.box(r),Reflect.defineProperty(this,f.name,{get(){return r.get()},set:_=>{y.runInAction(()=>r.set(_)),this.produceDraft(f.name,r.get()),this.checkChange(f.name,r.get())},enumerable:!0,configurable:!0}),r}cloneForInit(t){if(t)try{const r=V.cloneDeep(t);this.initData=r,this.rawInitData=r}catch{const f=Object.assign({},t);this.initData=f,this.rawInitData=f}else this.rawInitData=null}checkChange(t,r){const f=V.cloneDeep(r),_=V.cloneDeep(Reflect.get(this.committedData,t))||V.cloneDeep(Reflect.get(this.initData,t)),m=t&&t in this.initData&&!V.isEqual(_,f);return y.runInAction(()=>{m&&Reflect.set(this.modified_,t,V.cloneDeep(_)||_);for(const O in this.modified_)t===O&&t in this.modified_&&V.isEqual(_,f)&&delete this.modified_[O]}),m}defineData(t){for(const r in this){if(!Object.prototype.hasOwnProperty.call(this,r))continue;N.fieldInstance(r,this)&&(Reflect.set(this,r,Reflect.get(t,r)),this.initField(r))}}get dirty(){return!V.isEmpty(this.modified_)}commit(){for(const t of N.fields(this))this.commitField(t.name);this.modified_={}}commitField(t){for(const r in this)r in this.modified_&&Reflect.set(this.committedData,r,this[r]);delete this.modified_[t],this.modified_=Object.assign({},this.modified_)}reject(){for(const t in this)t in this.modified_&&(this[t]=Reflect.get(this.modified_,t),this.commitField(t),this.defineFieldValue(t,this[t]));this.commit()}toInit(){return this.withHistoryMuted(()=>{for(const t in this)if(t in this.initData){const r=Reflect.get(this.initData,t);this[t]=r,this.initField(t)}this.init(this.initData)}),this}undo(){if(this.historyIndex<0)return;const t=this.history[this.historyIndex];this.historyIndex-=1,this.applyHistoryPatches(t.inversePatches),this.syncChangesFromHistory()}redo(){if(this.historyIndex>=this.history.length-1)return;const t=this.historyIndex+1,r=this.history[t];this.historyIndex=t,this.applyHistoryPatches(r.patches),this.syncChangesFromHistory()}goToHistory(t){if(!(t<-1||t>=this.history.length)&&t!==this.historyIndex){for(;this.historyIndex<t;){const r=this.historyIndex+1,f=this.history[r];this.historyIndex=r,this.applyHistoryPatches(f.patches)}for(;this.historyIndex>t;){const r=this.history[this.historyIndex];this.historyIndex-=1,this.applyHistoryPatches(r.inversePatches)}this.syncChangesFromHistory()}}loadData(t){return this.withHistoryMuted(()=>{this.init(t),this.defineData(this.initData)}),this}get dumpData(){this.initLegacyFields();const t=Object.create({}),r=_=>{const m=Ve.fieldInstance(_,this);return m?.callback?m.callback(Reflect.get(this,_),this):Reflect.get(this,_)},f=_=>{const m=xe.fieldInstance(_,this);if(m)switch(typeof m.callback){case"boolean":return!!m.callback;case"function":return m.callback(Reflect.get(this,_),this)}return!1};N.fields(this).forEach(_=>{var m;if(_.name in this)return!((m=this.options)===null||m===void 0)&&m.byFields&&!this.options.byFields.includes(_.name)||f(_.name)?void 0:Reflect.set(t,_.name,r(_.name))});try{return V.cloneDeep(t)}catch{return t&&Object.assign({},t)}}get validation(){this.initLegacyFields();const t={};for(const r in this){const f=Fe.fieldInstance(r,this);f&&Reflect.set(t,r,f.callback(this[r],this)||"")}return t}get validAndDirty(){return this.dirty&&Object.values(this.validation).filter(Boolean).length===0}get service(){return{dirty:this.dirty,dumpData:this.dumpData,loadData:t=>this.loadData(t),validation:this.validation,reject:this.reject.bind(this),commit:this.commit.bind(this),commitField:this.commitField.bind(this),changes:this.changes,inverseChanges:this.inverseChanges,history:this.history,historyIndex:this.historyIndex,toInit:()=>this.toInit(),undo:this.undo.bind(this),redo:this.redo.bind(this),goToHistory:this.goToHistory.bind(this)}}},a=new WeakMap,d=new WeakMap,o=new WeakMap,i=new WeakMap,s=new WeakMap,n=new WeakMap,c=new WeakMap,g=[E],u=l.__propKey(X.immerable),(()=>{const I=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;T=[y.observable,E],B=[y.observable,E],h=[y.observable,E],R=[E],K=[y.observable,E],$=[y.observable,E],at=[y.observable,E],pt=[y.observable,E],Ot=[E],kt=[E],Tt=[E],Ft=[E],Et=[y.action],jt=[E],Ct=[y.action],Ht=[y.computed],Kt=[y.action],Gt=[y.action],Yt=[y.action],Bt=[y.action],Nt=[y.action],qt=[y.action],Ut=[y.action],$t=[y.computed],Wt=[y.computed],Jt=[(v=y.computed).struct.bind(v)],l.__esDecorate(e,null,T,{kind:"accessor",name:"initData",static:!1,private:!1,access:{has:t=>"initData"in t,get:t=>t.initData,set:(t,r)=>{t.initData=r}},metadata:I},L,H),l.__esDecorate(e,null,B,{kind:"accessor",name:"committedData",static:!1,private:!1,access:{has:t=>"committedData"in t,get:t=>t.committedData,set:(t,r)=>{t.committedData=r}},metadata:I},tt,z),l.__esDecorate(e,null,h,{kind:"accessor",name:"modified_",static:!1,private:!1,access:{has:t=>"modified_"in t,get:t=>t.modified_,set:(t,r)=>{t.modified_=r}},metadata:I},A,S),l.__esDecorate(e,null,K,{kind:"accessor",name:"changes",static:!1,private:!1,access:{has:t=>"changes"in t,get:t=>t.changes,set:(t,r)=>{t.changes=r}},metadata:I},G,U),l.__esDecorate(e,null,$,{kind:"accessor",name:"inverseChanges",static:!1,private:!1,access:{has:t=>"inverseChanges"in t,get:t=>t.inverseChanges,set:(t,r)=>{t.inverseChanges=r}},metadata:I},et,it),l.__esDecorate(e,null,at,{kind:"accessor",name:"history",static:!1,private:!1,access:{has:t=>"history"in t,get:t=>t.history,set:(t,r)=>{t.history=r}},metadata:I},gt,bt),l.__esDecorate(e,null,pt,{kind:"accessor",name:"historyIndex",static:!1,private:!1,access:{has:t=>"historyIndex"in t,get:t=>t.historyIndex,set:(t,r)=>{t.historyIndex=r}},metadata:I},Dt,It),l.__esDecorate(e,null,Et,{kind:"method",name:"resetToDefault",static:!1,private:!1,access:{has:t=>"resetToDefault"in t,get:t=>t.resetToDefault},metadata:I},null,p),l.__esDecorate(e,null,Ct,{kind:"method",name:"produceDraft",static:!1,private:!1,access:{has:t=>"produceDraft"in t,get:t=>t.produceDraft},metadata:I},null,p),l.__esDecorate(e,null,Ht,{kind:"getter",name:"dirty",static:!1,private:!1,access:{has:t=>"dirty"in t,get:t=>t.dirty},metadata:I},null,p),l.__esDecorate(e,null,Kt,{kind:"method",name:"commit",static:!1,private:!1,access:{has:t=>"commit"in t,get:t=>t.commit},metadata:I},null,p),l.__esDecorate(e,null,Gt,{kind:"method",name:"commitField",static:!1,private:!1,access:{has:t=>"commitField"in t,get:t=>t.commitField},metadata:I},null,p),l.__esDecorate(e,null,Yt,{kind:"method",name:"reject",static:!1,private:!1,access:{has:t=>"reject"in t,get:t=>t.reject},metadata:I},null,p),l.__esDecorate(e,null,Bt,{kind:"method",name:"toInit",static:!1,private:!1,access:{has:t=>"toInit"in t,get:t=>t.toInit},metadata:I},null,p),l.__esDecorate(e,null,Nt,{kind:"method",name:"undo",static:!1,private:!1,access:{has:t=>"undo"in t,get:t=>t.undo},metadata:I},null,p),l.__esDecorate(e,null,qt,{kind:"method",name:"redo",static:!1,private:!1,access:{has:t=>"redo"in t,get:t=>t.redo},metadata:I},null,p),l.__esDecorate(e,null,Ut,{kind:"method",name:"goToHistory",static:!1,private:!1,access:{has:t=>"goToHistory"in t,get:t=>t.goToHistory},metadata:I},null,p),l.__esDecorate(e,null,$t,{kind:"getter",name:"validation",static:!1,private:!1,access:{has:t=>"validation"in t,get:t=>t.validation},metadata:I},null,p),l.__esDecorate(e,null,Wt,{kind:"getter",name:"validAndDirty",static:!1,private:!1,access:{has:t=>"validAndDirty"in t,get:t=>t.validAndDirty},metadata:I},null,p),l.__esDecorate(e,null,Jt,{kind:"getter",name:"service",static:!1,private:!1,access:{has:t=>"service"in t,get:t=>t.service},metadata:I},null,p),l.__esDecorate(null,null,g,{kind:"field",name:u,static:!1,private:!1,access:{has:t=>u in t,get:t=>t[u],set:(t,r)=>{t[u]=r}},metadata:I},D,M),l.__esDecorate(null,null,R,{kind:"field",name:"draft",static:!1,private:!1,access:{has:t=>"draft"in t,get:t=>t.draft,set:(t,r)=>{t.draft=r}},metadata:I},x,w),l.__esDecorate(null,null,Ot,{kind:"field",name:"initializedFields",static:!1,private:!1,access:{has:t=>"initializedFields"in t,get:t=>t.initializedFields,set:(t,r)=>{t.initializedFields=r}},metadata:I},St,Mt),l.__esDecorate(null,null,kt,{kind:"field",name:"legacyInitDone",static:!1,private:!1,access:{has:t=>"legacyInitDone"in t,get:t=>t.legacyInitDone,set:(t,r)=>{t.legacyInitDone=r}},metadata:I},wt,zt),l.__esDecorate(null,null,Tt,{kind:"field",name:"rawInitData",static:!1,private:!1,access:{has:t=>"rawInitData"in t,get:t=>t.rawInitData,set:(t,r)=>{t.rawInitData=r}},metadata:I},At,Vt),l.__esDecorate(null,null,Ft,{kind:"field",name:"options",static:!1,private:!1,access:{has:t=>"options"in t,get:t=>t.options,set:(t,r)=>{t.options=r}},metadata:I},xt,Pt),l.__esDecorate(null,null,jt,{kind:"field",name:"historyMuted",static:!1,private:!1,access:{has:t=>"historyMuted"in t,get:t=>t.historyMuted,set:(t,r)=>{t.historyMuted=r}},metadata:I},Rt,Lt),I&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:I})})(),e})();const re=Symbol("store-key"),Ee=()=>{var e;return(e=globalThis.__REDUX_DEVTOOLS_EXTENSION__)!==null&&e!==void 0?e:null},je=()=>{var e;return(e=globalThis.__MVVM_DEVTOOLS_APPLYING__)!==null&&e!==void 0?e:0},Re=e=>{var a,d;const o=globalThis;o.__MVVM_DEVTOOLS_APPLYING__=((a=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&a!==void 0?a:0)+1;try{return e()}finally{o.__MVVM_DEVTOOLS_APPLYING__=Math.max(0,((d=o.__MVVM_DEVTOOLS_APPLYING__)!==null&&d!==void 0?d:1)-1)}},Le=()=>je()>0,mt=e=>({items:e.items.map(a=>{var d,o;return{name:(o=(d=a.constructor)===null||d===void 0?void 0:d.name)!==null&&o!==void 0?o:"Model",data:a.service.dumpData,historyIndex:a.service.historyIndex}})}),Ce=e=>!!(e&&typeof e=="object"&&Array.isArray(e.items)),He=e=>{if(!e)return null;try{const a=JSON.parse(e);return Ce(a)?a:null}catch{return null}},oe=(e,a={})=>{var d,o;const i=Ee();if(!i)return()=>{};const s=i.connect({name:a.name,instanceId:a.instanceId});let n=!1,c=(o=(d=e.items[0])===null||d===void 0?void 0:d.constructor)!==null&&o!==void 0?o:null;try{s.init(mt(e))}catch{}const u=y.reaction(()=>mt(e),g=>{var D;if(n||Le())return;const M=(D=e.items[0])===null||D===void 0?void 0:D.constructor;M&&(c=M);try{s.send({type:"store:update"},g)}catch{}}),v=g=>(n=!0,Re(()=>{try{return g()}finally{n=!1}})),p=s.subscribe(g=>{var D;if(g.type!=="DISPATCH")return;const M=(D=g.payload)===null||D===void 0?void 0:D.type;if(M==="RESET"||M==="ROLLBACK"){v(()=>e.reset());return}if(M==="JUMP_TO_ACTION"||M==="JUMP_TO_STATE"){const T=He(g.state);if(!T)return;v(()=>{var L,H,B;if(T.items.length===e.items.length&&e.items.every(S=>{var R,x;return typeof((R=S?.service)===null||R===void 0?void 0:R.goToHistory)=="function"||typeof((x=S?.service)===null||x===void 0?void 0:x.loadData)=="function"})){y.runInAction(()=>{T.items.forEach((S,R)=>{var x;const w=(x=e.items[R])===null||x===void 0?void 0:x.service,K=S.historyIndex,G=w?.history;if(Array.isArray(G)&&G.length>0&&typeof K=="number"&&typeof w?.goToHistory=="function"&&(K===-1&&G.length>0||K<G.length)){w.goToHistory(K);return}typeof w?.loadData=="function"&&w.loadData(S.data)})});return}const z=(H=(L=e.items[0])===null||L===void 0?void 0:L.constructor)!==null&&H!==void 0?H:c,h=T.items.map(S=>S.data);if(z){e.applyLoaded(h,{model:z,cash:!1}),c=z;return}e.applyLoaded(h,{cash:!1});const A=(B=e.items[0])===null||B===void 0?void 0:B.constructor;A&&(c=A)})}});return()=>{u(),typeof p=="function"&&p(),typeof s.unsubscribe=="function"&&s.unsubscribe(),typeof s.disconnect=="function"&&s.disconnect()}};let Ke=(()=>{var e,a,d;let o=[],i,s=[],n=[],c,u=[],v=[],p,g,D,M,T,L,H,B,tt;return e=class{get items(){return l.__classPrivateFieldGet(this,a,"f")}set items(h){l.__classPrivateFieldSet(this,a,h,"f")}get _cash(){return l.__classPrivateFieldGet(this,d,"f")}set _cash(h){l.__classPrivateFieldSet(this,d,h,"f")}constructor(){a.set(this,(l.__runInitializers(this,o),l.__runInitializers(this,s,[]))),d.set(this,(l.__runInitializers(this,n),l.__runInitializers(this,u,[]))),l.__runInitializers(this,v),y.makeObservable(this),this.autoAttachDevtools()}add(h){this.items=[...this.items,h]}remove(h){this.items=this.items.filter(A=>A!==h)}find(h){return this.items.find(h)}filter(h){return this.items.filter(h)}findBy(h,A){return this.items.find(S=>S?.[h]===A)}clear(){this.items=[]}get size(){return this.items.length}get snapshot(){return mt(this)}get cash(){return this._cash}reset(){this.clear()}applyLoaded(h,A={}){const{model:S,mode:R="replace",cash:x=!0}=A;if(x&&this.setCash(h),R==="append"){this.items=[...this.items,...[S?h.map(w=>new S(w)):h].flat(1)];return}this.items=S?h.map(w=>new S(w)):h}setCash(h){this._cash=h??[]}autoAttachDevtools(){var h,A,S,R,x,w,K,G;const U=globalThis;if(!U.__MVVM_DEVTOOLS_AUTO__)return;const $=j(re,this.constructor,{})||{};if(((h=$.devtools)===null||h===void 0?void 0:h.enabled)===!1)return;const et=(x=(S=(A=$.devtools)===null||A===void 0?void 0:A.name)!==null&&S!==void 0?S:(R=this.constructor)===null||R===void 0?void 0:R.name)!==null&&x!==void 0?x:"Store",it=((w=U.__MVVM_DEVTOOLS_STORE_SEQ__)!==null&&w!==void 0?w:0)+1;U.__MVVM_DEVTOOLS_STORE_SEQ__=it;const at=(G=(K=$.devtools)===null||K===void 0?void 0:K.instanceId)!==null&&G!==void 0?G:`${et}#${it}`;oe(this,{name:et,instanceId:at})}},a=new WeakMap,d=new WeakMap,(()=>{const z=typeof Symbol=="function"&&Symbol.metadata?Object.create(null):void 0;i=[y.observable],c=[y.observable],p=[y.action],g=[y.action],D=[y.action],M=[y.computed],T=[y.computed],L=[y.computed],H=[y.action],B=[y.action],tt=[y.action],l.__esDecorate(e,null,i,{kind:"accessor",name:"items",static:!1,private:!1,access:{has:h=>"items"in h,get:h=>h.items,set:(h,A)=>{h.items=A}},metadata:z},s,n),l.__esDecorate(e,null,c,{kind:"accessor",name:"_cash",static:!1,private:!1,access:{has:h=>"_cash"in h,get:h=>h._cash,set:(h,A)=>{h._cash=A}},metadata:z},u,v),l.__esDecorate(e,null,p,{kind:"method",name:"add",static:!1,private:!1,access:{has:h=>"add"in h,get:h=>h.add},metadata:z},null,o),l.__esDecorate(e,null,g,{kind:"method",name:"remove",static:!1,private:!1,access:{has:h=>"remove"in h,get:h=>h.remove},metadata:z},null,o),l.__esDecorate(e,null,D,{kind:"method",name:"clear",static:!1,private:!1,access:{has:h=>"clear"in h,get:h=>h.clear},metadata:z},null,o),l.__esDecorate(e,null,M,{kind:"getter",name:"size",static:!1,private:!1,access:{has:h=>"size"in h,get:h=>h.size},metadata:z},null,o),l.__esDecorate(e,null,T,{kind:"getter",name:"snapshot",static:!1,private:!1,access:{has:h=>"snapshot"in h,get:h=>h.snapshot},metadata:z},null,o),l.__esDecorate(e,null,L,{kind:"getter",name:"cash",static:!1,private:!1,access:{has:h=>"cash"in h,get:h=>h.cash},metadata:z},null,o),l.__esDecorate(e,null,H,{kind:"method",name:"reset",static:!1,private:!1,access:{has:h=>"reset"in h,get:h=>h.reset},metadata:z},null,o),l.__esDecorate(e,null,B,{kind:"method",name:"applyLoaded",static:!1,private:!1,access:{has:h=>"applyLoaded"in h,get:h=>h.applyLoaded},metadata:z},null,o),l.__esDecorate(e,null,tt,{kind:"method",name:"setCash",static:!1,private:!1,access:{has:h=>"setCash"in h,get:h=>h.setCash},metadata:z},null,o),z&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:z})})(),e})();function Ge(e){return q(e,"instance")}function Ye(e){return((a,d)=>ae(e)(a,d))}function Be(e,a){const d=(o,i)=>{var s;const n=typeof e=="string"?{id:e}:typeof e=="object"?e:{id:(s=i?.name)!==null&&s!==void 0?s:o?.name};P(re,n,o),vt(n)(o,i)};return typeof e=="function"?d(e,a):(o,i)=>d(o,i)}class Ne{}const ct=new yt;function qe(e,a){return de.observer((d={})=>{const{resolved:o,instance:i}=Zt.useMemo(()=>{const n=q(e)||(typeof e!="string"?{instance:new e}:void 0),c=n?.instance;return{resolved:n,instance:c}},[e]);if(Zt.useEffect(()=>{if(i)return typeof i.onInit=="function"&&i.onInit(),()=>{typeof i.onDispose=="function"&&i.onDispose()}},[i]),o){const s=ct.fields(i),n=s.length>0?s:ct.fields(Object.getPrototypeOf(i));for(const c in d)if(n instanceof Array){const u=n.find(v=>v.name===c);u&&Reflect.set(i,u.originName,Reflect.get(d,c))}return P(ct.metadataKey,n,i),a(Object.assign({viewModel:i},d))}return a(Object.assign({},d))})}exports.GetService=q;exports.GetStore=Ge;exports.Inject=ae;exports.InjectStore=Ye;exports.MakeObservable=we;exports.Model=Pe;exports.PropFromView=ke;exports.Service=vt;exports.SetService=_e;exports.Store=Be;exports.StoreBase=Ke;exports.TODO=ue;exports.ViewModel=Ne;exports.attachModelDevtools=ne;exports.attachStoreDevtools=oe;exports.defineMetadata=P;exports.define_prop=E;exports.exclude=Se;exports.field=Me;exports.getExecutingFunctionNameByStack=se;exports.getOwnMetadata=j;exports.isSerializable=he;exports.submit=Oe;exports.validation=Ie;exports.view=qe;
//# sourceMappingURL=index.cjs.map
