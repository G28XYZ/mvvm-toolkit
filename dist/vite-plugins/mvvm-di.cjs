"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const v=require("../tslib.es6--9daFdVU.cjs"),m=require("node:fs/promises"),a=require("node:path"),l=require("typescript"),Q="Service",Y="Store",E="rvm-toolkit";function ee(){let P,p="",u="";function W(){return v.__awaiter(this,void 0,void 0,function*(){const t=yield O(p);for(const i of t)yield F(i)})}function z(){return v.__awaiter(this,void 0,void 0,function*(){if(!u||(yield I(u)))return;const i=yield K(p);if(i.length===0){const o=[`declare module "${E}" {`,"  interface DiServices {}","}",""].join(`
`);yield m.writeFile(u,o,"utf8");return}const e=[],r=[],n=[];for(const o of i){const c=yield m.readFile(o,"utf8"),f=R(o),d=N(o),$=g(a.dirname(u),o);c.includes(`export interface ${f}`)&&(e.push(`import type { ${f} } from "${$}";`),r.push(f)),c.includes(`export interface ${d}`)&&(e.push(`import type { ${d} } from "${$}";`),n.push(d))}const s=[...e,"",`declare module "${E}" {`,r.length?`  interface DiServices extends ${r.join(", ")} {}`:"  interface DiServices {}",n.length?`  interface DiStores extends ${n.join(", ")} {}`:"  interface DiStores {}","}",""].join(`
`);yield m.writeFile(u,s,"utf8")})}function F(t){return v.__awaiter(this,void 0,void 0,function*(){const i=yield B(t);for(const e of i)yield M(e)})}function B(t){return v.__awaiter(this,void 0,void 0,function*(){var i,e;const r=yield m.readFile(t,"utf8"),n=t.endsWith(".tsx")?l.ScriptKind.TSX:l.ScriptKind.TS,s=l.createSourceFile(t,r,l.ScriptTarget.Latest,!0,n),o=new Set,c=new Set;for(const d of s.statements){if(!l.isImportDeclaration(d)||d.moduleSpecifier.getText(s).replace(/['"]/g,"")!==E)continue;const h=d.importClause;if(!(!h?.namedBindings||!l.isNamedImports(h.namedBindings)))for(const _ of h.namedBindings.elements){const w=(e=(i=_.propertyName)===null||i===void 0?void 0:i.text)!==null&&e!==void 0?e:_.name.text,x=_.name.text;w===Q&&o.add(x),w===Y&&c.add(x)}}if(o.size===0&&c.size===0)return[];const f=[];return s.forEachChild(d=>{var $;if(!l.isClassDeclaration(d)||!d.name)return;const h=d.name.text,_=($=l.getDecorators(d))!==null&&$!==void 0?$:[];for(const w of _){const x=w.expression;if(l.isIdentifier(x)&&o.has(x.text))o.has(x.text)?f.push({className:h,entryKey:h,filePath:t,kind:"service"}):c.has(x.text)&&f.push({className:h,entryKey:h,filePath:t,kind:"store"});else if(l.isCallExpression(x)&&l.isIdentifier(x.expression)){const L=x.expression.text,G=o.has(L),A=c.has(L);if(!G&&!A)continue;const[y]=x.arguments;let b=h;if(y&&l.isStringLiteralLike(y))b=y.text;else if(y&&l.isObjectLiteralExpression(y)){const j=y.properties.find(D=>l.isPropertyAssignment(D)&&l.isIdentifier(D.name)&&D.name.text==="id"&&l.isStringLiteralLike(D.initializer));j&&l.isStringLiteralLike(j.initializer)&&(b=j.initializer.text)}f.push({className:h,entryKey:b,filePath:t,kind:A?"store":"service"})}}}),f})}function M(t){return v.__awaiter(this,void 0,void 0,function*(){const i=yield q(t.filePath),e=i.existed,r=X(t.entryKey),n=t.kind==="store"?N(i.containerPath):R(i.containerPath),s=t.kind==="store"?"DiStores":"DiServices";if(!e){const f=g(a.dirname(i.containerPath),t.filePath),d=[`import type { ${t.className} } from "${f}";`,"",`export interface ${n} {`,`  ${r}: typeof ${t.className};`,"}",""].join(`
`);yield m.writeFile(i.containerPath,d,"utf8"),yield k(i.containerPath,n,s);return}const o=yield m.readFile(i.containerPath,"utf8"),c=U(o,i.containerPath,Object.assign(Object.assign({},t),{entryKey:r,interfaceName:n}));c!==o&&(yield m.writeFile(i.containerPath,c,"utf8")),yield k(i.containerPath,n,s)})}function q(t){return v.__awaiter(this,void 0,void 0,function*(){const i=a.resolve(t);let e=a.dirname(i);for(;e.startsWith(p);){const o=a.join(e,"container.d.ts");if(yield I(o))return{containerPath:o,existed:!0};if(e===p)break;e=a.dirname(e)}const n=a.relative(p,i).split(a.sep);let s=p;return n[0]==="modules"&&n.length>1?s=a.join(p,"modules",n[1]):n.length>0&&n[0]&&(s=a.join(p,n[0])),{containerPath:a.join(s,"container.d.ts"),existed:!1}})}function U(t,i,e){const r=g(a.dirname(i),e.filePath),n=`import type { ${e.className} } from "${r}";`;let s=t;new RegExp(`^import type \\{ ${e.className} \\} from \\"${S(r)}\\";`,"m").test(t)||(s=V(s,n));const o=H(s,e.interfaceName);if(!o){const c=["",`export interface ${e.interfaceName} {`,`  ${e.entryKey}: typeof ${e.className};`,"}",""].join(`
`);return`${s.trimEnd()}
${c}`}if(!new RegExp(`${S(e.entryKey)}\\s*:`).test(o.body)){const c=`${o.indent}${e.entryKey}: typeof ${e.className};`;s=s.slice(0,o.endIndex)+`
${c}`+s.slice(o.endIndex)}return s}function k(t,i,e){return v.__awaiter(this,void 0,void 0,function*(){if(!u)return;if(!(yield I(u))){const f=g(a.dirname(u),t),$=[`import type { ${i} } from "${f}";`,"",`declare module "${E}" {`,`  interface ${e} extends ${i} {}`,"}",""].join(`
`);yield m.writeFile(u,$,"utf8");return}const n=yield m.readFile(u,"utf8");let s=n;const o=g(a.dirname(u),t),c=`import type { ${i} } from "${o}";`;new RegExp(`^import type \\{ ${i} \\} from \\"${S(o)}\\";`,"m").test(s)||(s=Z(s,c)),s=C(s,"DiServices"),s=C(s,"DiStores"),s=J(s,e,i),s!==n&&(yield m.writeFile(u,s,"utf8"))})}function V(t,i){const e=t.split(`
`);let r=0;for(let n=0;n<e.length;n+=1)if(e[n].startsWith("import "))r=n+1;else if(e[n].trim()!=="")break;return e.splice(r,0,i),e.join(`
`)}function Z(t,i){const e=t.split(`
`);let r=0;for(let n=0;n<e.length;n+=1)if(e[n].startsWith("import "))r=n+1;else if(e[n].trim()!=="")break;return e.splice(r,0,i),e.join(`
`)}function H(t,i){const e=t.match(new RegExp(`export interface ${S(i)}\\s*\\{`));if(!e||e.index===void 0)return null;const r=e.index+e[0].length,n=t.indexOf("}",r);if(n===-1)return null;const s=t.slice(r,n),o=s.match(/\n(\s*)\w/),c=o?o[1]:"  ";return{body:s,endIndex:n,indent:c}}function C(t,i){const e=new RegExp(`interface ${i},\\s*([^\\{]+)\\{`,"g");return t.replace(e,`interface ${i} extends $1{`)}function J(t,i,e){var r;const n=t.match(new RegExp(`interface ${i}(\\s+extends\\s+([^\\{]+))?\\s*\\{`));if(!n||n.index===void 0)return t;const s=(r=n[2])===null||r===void 0?void 0:r.trim();if(s&&new RegExp(`\\b${S(e)}\\b`).test(s))return t;const o=s?` extends ${s}, ${e} {`:` extends ${e} {`,c=n.index,f=c+n[0].length;return t.slice(0,c)+`interface ${i}${o}`+t.slice(f)}function R(t){const e=a.relative(p,t).replace(/\\/g,"/").split("/");let r=e[0];return e[0]==="modules"&&e[1]&&(r=e[1]),`${T(r.replace(/\.d\.ts$/,""))}Services`}function N(t){const e=a.relative(p,t).replace(/\\/g,"/").split("/");let r=e[0];return e[0]==="modules"&&e[1]&&(r=e[1]),`${T(r.replace(/\.d\.ts$/,""))}Stores`}function T(t){return t.split(/[^a-zA-Z0-9]+/).filter(Boolean).map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join("")}function X(t){return/^[A-Za-z_$][A-Za-z0-9_$]*$/.test(t)?t:JSON.stringify(t)}function g(t,i){const r=a.relative(t,i).replace(/\\/g,"/").replace(/\.(tsx|ts|d\.ts)$/,"");return r.startsWith(".")?r:`./${r}`}function S(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function O(t){return v.__awaiter(this,void 0,void 0,function*(){const i=yield m.readdir(t,{withFileTypes:!0}),e=[];for(const r of i){if(r.name.startsWith("."))continue;const n=a.join(t,r.name);if(r.isDirectory())e.push(...yield O(n));else if(r.isFile()){if(!/\.tsx?$/.test(r.name)||r.name.endsWith(".d.ts"))continue;e.push(n)}}return e})}function K(t){return v.__awaiter(this,void 0,void 0,function*(){const i=yield m.readdir(t,{withFileTypes:!0}),e=[];for(const r of i){if(r.name.startsWith("."))continue;const n=a.join(t,r.name);r.isDirectory()?e.push(...yield K(n)):r.isFile()&&r.name==="container.d.ts"&&e.push(n)}return e})}function I(t){return v.__awaiter(this,void 0,void 0,function*(){try{return yield m.access(t),!0}catch{return!1}})}return{name:"mvvm-service-di",enforce:"pre",configResolved(t){var i,e;P=t,p=a.resolve((i=P.root)!==null&&i!==void 0?i:process.cwd(),"src"),u=a.resolve((e=P.root)!==null&&e!==void 0?e:process.cwd(),"di.d.ts")},buildStart(){return v.__awaiter(this,void 0,void 0,function*(){yield z(),yield W()})},handleHotUpdate(t){return v.__awaiter(this,void 0,void 0,function*(){t.file.startsWith(p)&&(!/\.tsx?$/.test(t.file)||t.file.endsWith(".d.ts")||(yield F(t.file)))})}}}exports.mvvmServiceDiPlugin=ee;
//# sourceMappingURL=mvvm-di.cjs.map
