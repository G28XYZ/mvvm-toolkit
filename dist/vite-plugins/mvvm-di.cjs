"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const u=require("../tslib.es6--9daFdVU.cjs"),v=require("node:fs/promises"),l=require("node:path"),c=require("typescript"),me="Service",pe="Store",j="rvm-toolkit";function ve(){let b,g="",h="";function B(){return u.__awaiter(this,void 0,void 0,function*(){const e=yield L(g);for(const i of e)yield N(i)})}function V(){return u.__awaiter(this,void 0,void 0,function*(){if(!h||(yield D(h)))return;const i=yield W(g);if(i.length===0){const o=[`declare module "${j}" {`,"  interface DiServices {}","}",""].join(`
`);yield v.writeFile(h,o,"utf8");return}const t=[],n=[],r=[];for(const o of i){const d=yield v.readFile(o,"utf8"),f=k(o),a=P(o),p=E(l.dirname(h),o);d.includes(`export interface ${f}`)&&(t.push(`import type { ${f} } from "${p}";`),n.push(f)),d.includes(`export interface ${a}`)&&(t.push(`import type { ${a} } from "${p}";`),r.push(a))}const s=[...t,"",`declare module "${j}" {`,n.length?`  interface DiServices extends ${n.join(", ")} {}`:"  interface DiServices {}",r.length?`  interface DiStores extends ${r.join(", ")} {}`:"  interface DiStores {}","}",""].join(`
`);yield v.writeFile(h,s,"utf8")})}function N(e){return u.__awaiter(this,void 0,void 0,function*(){const i=yield q(e);for(const t of i)yield te(t)})}function q(e){return u.__awaiter(this,void 0,void 0,function*(){var i,t,n;const r=yield v.readFile(e,"utf8"),s=e.endsWith(".tsx")?c.ScriptKind.TSX:c.ScriptKind.TS,o=c.createSourceFile(e,r,c.ScriptTarget.Latest,!0,s),f=yield Z(o,e,{cache:new Map,resolving:new Set}),a=new Set,p=new Set;for(const m of o.statements){if(!c.isImportDeclaration(m)||m.moduleSpecifier.getText(o).replace(/['"]/g,"")!==j)continue;const _=m.importClause;if(!(!_?.namedBindings||!c.isNamedImports(_.namedBindings)))for(const w of _.namedBindings.elements){const y=(t=(i=w.propertyName)===null||i===void 0?void 0:i.text)!==null&&t!==void 0?t:w.name.text,C=w.name.text;y===me&&a.add(C),y===pe&&p.add(C)}}if(a.size===0&&p.size===0)return[];const $=[];for(const m of o.statements){if(!c.isClassDeclaration(m)||!m.name)continue;const x=m.name.text,_=(n=c.getDecorators(m))!==null&&n!==void 0?n:[];for(const w of _){const y=w.expression;if(c.isIdentifier(y)&&a.has(y.text))a.has(y.text)?$.push({className:x,entryKey:x,filePath:e,kind:"service"}):p.has(y.text)&&$.push({className:x,entryKey:x,filePath:e,kind:"store"});else if(c.isCallExpression(y)&&c.isIdentifier(y.expression)){const C=y.expression.text,ue=a.has(C),A=p.has(C);if(!ue&&!A)continue;const[fe]=y.arguments;let z=x;const O=yield U(fe,f);O&&(z=O),$.push({className:x,entryKey:z,filePath:e,kind:A?"store":"service"})}}}return $})}function U(e,i){return u.__awaiter(this,void 0,void 0,function*(){if(!e)return null;if(c.isObjectLiteralExpression(e)){const t=e.properties.find(n=>c.isPropertyAssignment(n)&&c.isIdentifier(n.name)&&n.name.text==="id");return t?S(t.initializer,i):null}return S(e,i)})}function Z(e,i,t){return u.__awaiter(this,void 0,void 0,function*(){const n=R(e),r=yield F(e,i);return{filePath:i,localConsts:n,importedConsts:r,localResolved:new Map,importedResolved:new Map,resolveState:t}})}function R(e){const i=new Map;for(const t of e.statements)if(c.isVariableStatement(t)&&t.declarationList.flags&c.NodeFlags.Const)for(const n of t.declarationList.declarations)!c.isIdentifier(n.name)||!n.initializer||i.set(n.name.text,n.initializer);return i}function F(e,i){return u.__awaiter(this,void 0,void 0,function*(){var t,n;const r=new Map;for(const s of e.statements){if(!c.isImportDeclaration(s)||!s.importClause||!c.isStringLiteralLike(s.moduleSpecifier))continue;const o=s.moduleSpecifier.text,d=s.importClause.namedBindings;if(!d||!c.isNamedImports(d))continue;const f=yield J(i,o);if(f)for(const a of d.elements){const p=(n=(t=a.propertyName)===null||t===void 0?void 0:t.text)!==null&&n!==void 0?n:a.name.text,$=a.name.text;r.set($,{importName:p,sourcePath:f})}}return r})}function J(e,i){return u.__awaiter(this,void 0,void 0,function*(){if(!i.startsWith("."))return null;const t=l.resolve(l.dirname(e),i),r=l.extname(i)?[t]:[`${t}.ts`,`${t}.tsx`,`${t}.js`,`${t}.jsx`,`${t}.d.ts`,l.join(t,"index.ts"),l.join(t,"index.tsx"),l.join(t,"index.js"),l.join(t,"index.jsx"),l.join(t,"index.d.ts")];for(const s of r)if(yield D(s))return s;return null})}function S(e,i){return u.__awaiter(this,void 0,void 0,function*(){if(c.isStringLiteralLike(e)||c.isNoSubstitutionTemplateLiteral(e))return e.text;if(c.isTemplateExpression(e)){let t=e.head.text;for(const n of e.templateSpans){const r=yield S(n.expression,i);if(r===null)return null;t+=r+n.literal.text}return t}if(c.isBinaryExpression(e)&&e.operatorToken.kind===c.SyntaxKind.PlusToken){const t=yield S(e.left,i);if(t===null)return null;const n=yield S(e.right,i);return n===null?null:t+n}return c.isIdentifier(e)?X(e.text,i):c.isAsExpression(e)||c.isTypeAssertionExpression(e)||c.isParenthesizedExpression(e)?S(e.expression,i):null})}function X(e,i){return u.__awaiter(this,void 0,void 0,function*(){var t,n;if(i.localResolved.has(e))return(t=i.localResolved.get(e))!==null&&t!==void 0?t:null;const r=i.localConsts.get(e);if(r){const o=yield S(r,i);return i.localResolved.set(e,o),o}const s=i.importedConsts.get(e);if(s){if(i.importedResolved.has(e))return(n=i.importedResolved.get(e))!==null&&n!==void 0?n:null;const o=yield H(s,i.resolveState);return i.importedResolved.set(e,o),o}return null})}function H(e,i){return u.__awaiter(this,void 0,void 0,function*(){var t;const n=`${e.sourcePath}::${e.importName}`;if(i.cache.has(n))return(t=i.cache.get(n))!==null&&t!==void 0?t:null;if(i.resolving.has(n))return null;i.resolving.add(n);const r=yield G(e.sourcePath,e.importName,i);return i.resolving.delete(n),i.cache.set(n,r),r})}function G(e,i,t){return u.__awaiter(this,void 0,void 0,function*(){const n=yield Y(e),s=Q(n).get(i);if(!s)return null;const o=R(n),d=o.get(s);if(!d)return null;const f=yield F(n,e);return S(d,{localConsts:o,importedConsts:f,localResolved:new Map,importedResolved:new Map,resolveState:t})})}function Q(e){var i,t,n;const r=new Map;for(const s of e.statements)if(c.isVariableStatement(s)&&(!((i=s.modifiers)===null||i===void 0)&&i.some(o=>o.kind===c.SyntaxKind.ExportKeyword)))for(const o of s.declarationList.declarations)c.isIdentifier(o.name)&&r.set(o.name.text,o.name.text);else if(c.isExportDeclaration(s)&&s.exportClause&&c.isNamedExports(s.exportClause)){if(s.moduleSpecifier)continue;for(const o of s.exportClause.elements){const d=o.name.text,f=(n=(t=o.propertyName)===null||t===void 0?void 0:t.text)!==null&&n!==void 0?n:o.name.text;r.set(d,f)}}return r}function Y(e){return u.__awaiter(this,void 0,void 0,function*(){const i=yield v.readFile(e,"utf8"),t=ee(e);return c.createSourceFile(e,i,c.ScriptTarget.Latest,!0,t)})}function ee(e){return e.endsWith(".tsx")?c.ScriptKind.TSX:e.endsWith(".ts")||e.endsWith(".d.ts")?c.ScriptKind.TS:e.endsWith(".jsx")?c.ScriptKind.JSX:e.endsWith(".js")?c.ScriptKind.JS:c.ScriptKind.TS}function te(e){return u.__awaiter(this,void 0,void 0,function*(){const i=yield ie(e.filePath),t=i.existed,n=de(e.entryKey),r=e.kind==="store"?P(i.containerPath):k(i.containerPath),s=e.kind==="store"?"DiStores":"DiServices";if(!t){const f=E(l.dirname(i.containerPath),e.filePath),a=[`import type { ${e.className} } from "${f}";`,"",`export interface ${r} {`,`  ${n}: typeof ${e.className};`,"}",""].join(`
`);yield v.writeFile(i.containerPath,a,"utf8"),yield K(i.containerPath,r,s);return}const o=yield v.readFile(i.containerPath,"utf8"),d=ne(o,i.containerPath,Object.assign(Object.assign({},e),{entryKey:n,interfaceName:r}));d!==o&&(yield v.writeFile(i.containerPath,d,"utf8")),yield K(i.containerPath,r,s)})}function ie(e){return u.__awaiter(this,void 0,void 0,function*(){const i=l.resolve(e);let t=l.dirname(i);for(;t.startsWith(g);){const o=l.join(t,"container.d.ts");if(yield D(o))return{containerPath:o,existed:!0};if(t===g)break;t=l.dirname(t)}const r=l.relative(g,i).split(l.sep);let s=g;return r[0]==="modules"&&r.length>1?s=l.join(g,"modules",r[1]):r.length>0&&r[0]&&(s=l.join(g,r[0])),{containerPath:l.join(s,"container.d.ts"),existed:!1}})}function ne(e,i,t){const n=E(l.dirname(i),t.filePath),r=`import type { ${t.className} } from "${n}";`;let s=e;new RegExp(`^import type \\{ ${t.className} \\} from \\"${I(n)}\\";`,"m").test(e)||(s=re(s,r));const o=oe(s,t.interfaceName);if(!o){const m=["",`export interface ${t.interfaceName} {`,`  ${t.entryKey}: typeof ${t.className};`,"}",""].join(`
`);return`${s.trimEnd()}
${m}`}const d=/^\s*("(?:\\.|[^"])*"|'(?:\\.|[^'])*'|[^:]+)\s*:\s*typeof\s+([A-Za-z0-9_$]+)\s*;.*$/,f=o.body.split(`
`),a=[];let p=!1,$=!1;for(const m of f){const x=m.match(d);if(!x){a.push(m);continue}const _=x[1].trim(),w=x[2].trim();if(_===t.entryKey){if(w===t.className)p=!0,a.push(m);else{const y=`${o.indent}${t.entryKey}: typeof ${t.className};`;a.push(y),p=!0,$=!0}continue}if(w===t.className){$=!0;continue}a.push(m)}if(!p){const m=`${o.indent}${t.entryKey}: typeof ${t.className};`,x=a.length>0&&a[a.length-1]===""?a.length-1:a.length;a.splice(x,0,m),$=!0}if($){const m=a.join(`
`);s=s.slice(0,o.startIndex)+m+s.slice(o.endIndex)}return s}function K(e,i,t){return u.__awaiter(this,void 0,void 0,function*(){if(!h)return;if(!(yield D(h))){const f=E(l.dirname(h),e),p=[`import type { ${i} } from "${f}";`,"",`declare module "${j}" {`,`  interface ${t} extends ${i} {}`,"}",""].join(`
`);yield v.writeFile(h,p,"utf8");return}const r=yield v.readFile(h,"utf8");let s=r;const o=E(l.dirname(h),e),d=`import type { ${i} } from "${o}";`;new RegExp(`^import type \\{ ${i} \\} from \\"${I(o)}\\";`,"m").test(s)||(s=se(s,d)),s=T(s,"DiServices"),s=T(s,"DiStores"),s=ce(s,t),s=le(s,t,i),s!==r&&(yield v.writeFile(h,s,"utf8"))})}function re(e,i){const t=e.split(`
`);let n=0;for(let r=0;r<t.length;r+=1)if(t[r].startsWith("import "))n=r+1;else if(t[r].trim()!=="")break;return t.splice(n,0,i),t.join(`
`)}function se(e,i){const t=e.split(`
`);let n=0;for(let r=0;r<t.length;r+=1)if(t[r].startsWith("import "))n=r+1;else if(t[r].trim()!=="")break;return t.splice(n,0,i),t.join(`
`)}function oe(e,i){const t=e.match(new RegExp(`export interface ${I(i)}\\s*\\{`));if(!t||t.index===void 0)return null;const n=t.index+t[0].length,r=e.indexOf("}",n);if(r===-1)return null;const s=e.slice(n,r),o=s.match(/\n(\s*)\w/),d=o?o[1]:"  ";return{body:s,endIndex:r,indent:d,startIndex:n}}function T(e,i){const t=new RegExp(`interface ${i},\\s*([^\\{]+)\\{`,"g");return e.replace(t,`interface ${i} extends $1{`)}function ce(e,i){if(new RegExp(`interface\\s+${i}\\b`).test(e))return e;const t=e.match(new RegExp(`declare module ["']${I(j)}["']\\s*\\{`));if(!t||t.index===void 0)return e;const n=t.index+t[0].length,r=ae(e,n);if(r===-1)return e;const s=`
  interface ${i} {}`;return e.slice(0,r)+s+e.slice(r)}function ae(e,i){let t=1;for(let n=i;n<e.length;n+=1){const r=e[n];if(r==="{"&&(t+=1),r==="}"&&(t-=1),t===0)return n}return-1}function le(e,i,t){var n;const r=e.match(new RegExp(`interface ${i}(\\s+extends\\s+([^\\{]+))?\\s*\\{`));if(!r||r.index===void 0)return e;const s=(n=r[2])===null||n===void 0?void 0:n.trim();if(s&&new RegExp(`\\b${I(t)}\\b`).test(s))return e;const o=s?` extends ${s}, ${t} {`:` extends ${t} {`,d=r.index,f=d+r[0].length;return e.slice(0,d)+`interface ${i}${o}`+e.slice(f)}function k(e){const t=l.relative(g,e).replace(/\\/g,"/").split("/");let n=t[0];return t[0]==="modules"&&t[1]&&(n=t[1]),`${M(n.replace(/\.d\.ts$/,""))}Services`}function P(e){const t=l.relative(g,e).replace(/\\/g,"/").split("/");let n=t[0];return t[0]==="modules"&&t[1]&&(n=t[1]),`${M(n.replace(/\.d\.ts$/,""))}Stores`}function M(e){return e.split(/[^a-zA-Z0-9]+/).filter(Boolean).map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join("")}function de(e){return/^[A-Za-z_$][A-Za-z0-9_$]*$/.test(e)?e:JSON.stringify(e)}function E(e,i){const n=l.relative(e,i).replace(/\\/g,"/").replace(/\.(tsx|ts|d\.ts)$/,"");return n.startsWith(".")?n:`./${n}`}function I(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function L(e){return u.__awaiter(this,void 0,void 0,function*(){const i=yield v.readdir(e,{withFileTypes:!0}),t=[];for(const n of i){if(n.name.startsWith("."))continue;const r=l.join(e,n.name);if(n.isDirectory())t.push(...yield L(r));else if(n.isFile()){if(!/\.tsx?$/.test(n.name)||n.name.endsWith(".d.ts"))continue;t.push(r)}}return t})}function W(e){return u.__awaiter(this,void 0,void 0,function*(){const i=yield v.readdir(e,{withFileTypes:!0}),t=[];for(const n of i){if(n.name.startsWith("."))continue;const r=l.join(e,n.name);n.isDirectory()?t.push(...yield W(r)):n.isFile()&&n.name==="container.d.ts"&&t.push(r)}return t})}function D(e){return u.__awaiter(this,void 0,void 0,function*(){try{return yield v.access(e),!0}catch{return!1}})}return{name:"mvvm-service-di",enforce:"pre",configResolved(e){var i,t;b=e,g=l.resolve((i=b.root)!==null&&i!==void 0?i:process.cwd(),"src"),h=l.resolve((t=b.root)!==null&&t!==void 0?t:process.cwd(),"di.d.ts")},buildStart(){return u.__awaiter(this,void 0,void 0,function*(){yield V(),yield B()})},handleHotUpdate(e){return u.__awaiter(this,void 0,void 0,function*(){e.file.startsWith(g)&&(!/\.tsx?$/.test(e.file)||e.file.endsWith(".d.ts")||(yield N(e.file)))})}}}exports.mvvmServiceDiPlugin=ve;
//# sourceMappingURL=mvvm-di.cjs.map
